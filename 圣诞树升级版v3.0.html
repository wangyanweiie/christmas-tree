<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Christmas Tree</title>
    <style>
        /* CSSÂèòÈáè - ‰∏ªÈ¢òËâ≤ */
        :root {
            --accent-color: #00ffcc;
            --accent-color-rgb: 0, 255, 204;
        }

        /* Âü∫Á°ÄÊ†∑Âºè */
        body {
            margin: 0;
            overflow: hidden;
            background: radial-gradient(circle at center, #0b1a2a 0%, #000000 100%);
            font-family: 'Times New Roman', serif;
        }

        #canvas-container {
            width: 100vw;
            height: 100vh;
            position: absolute;
            top: 0;
            left: 0;
        }

        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none;
        }

        /* Âä†ËΩΩÂä®Áîª */
        #loader {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.8s ease-out;
        }

        .loader-text {
            color: #aaddff;
            font-size: 14px;
            letter-spacing: 4px;
            margin-top: 20px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-top: 1px solid var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Ê†áÈ¢ò */
        h1 {
            position: absolute;
            top: 40px;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            text-align: center;
            margin: 0;
            pointer-events: none;
            font-size: 36px;
            font-weight: 400;
            background: linear-gradient(135deg, #e0f7fa 0%, #ffffff 50%, #88ccff 100%);
            background-size: 200% auto;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: aurora-shine 6s linear infinite;
            opacity: 0.9;
        }

        @keyframes aurora-shine {
            0% {
                background-position: 0% center;
            }

            100% {
                background-position: 300% center;
            }
        }

        /* ‰∏ä‰º†ÊåâÈíÆ */
        .upload-wrapper {
            position: absolute;
            top: 40px;
            right: 40px;
            z-index: 20;
            pointer-events: auto;
            display: flex;
            gap: 10px;
        }

        .upload-btn,
        .control-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50px;
            padding: 8px 20px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 10px;
            text-transform: uppercase;
            backdrop-filter: blur(5px);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-btn:hover,
        .control-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--accent-color);
            color: #fff;
            box-shadow: 0 0 10px rgba(var(--accent-color-rgb), 0.2);
        }

        .control-btn.active {
            background: rgba(var(--accent-color-rgb), 0.1);
            border-color: var(--accent-color);
            color: var(--accent-color);
        }

        #file-input,
        #import-input {
            display: none;
        }

        /* ÊëÑÂÉèÂ§¥È¢ÑËßàÁ™óÂè£ */
        #webcam-wrapper {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 160px;
            height: 120px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            opacity: 0.8;
            z-index: 20;
            background: #000;
        }

        #webcam-wrapper canvas {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }

        /* Êìç‰ΩúÊèêÁ§∫ */
        #tips {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            padding: 15px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 10px;
            backdrop-filter: blur(10px);
            z-index: 15;
        }

        .tip-item {
            margin: 6px 0;
        }

        .tip-key {
            color: var(--accent-color);
            display: inline-block;
            min-width: 60px;
        }

        /* ÁºìÂ≠òÁÆ°ÁêÜÊ®°ÊÄÅÊ°Ü */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-content {
            background: rgba(10, 20, 30, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            gap: 15px;
        }

        .header-actions {
            display: flex;
            gap: 8px;
            margin-left: auto;
            margin-right: 15px;
        }

        .modal-header h2 {
            margin: 0;
            color: #fff;
            font-size: 18px;
            font-weight: 400;
        }

        .modal-close {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .modal-close:hover {
            color: #fff;
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }

        .photo-item {
            position: relative;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .photo-item:hover {
            border-color: var(--accent-color);
            transform: translateY(-2px);
        }

        .photo-item.in-scene {
            border-color: var(--accent-color);
            box-shadow: 0 0 10px rgba(var(--accent-color-rgb), 0.3);
        }

        .photo-thumb {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            display: block;
        }

        .photo-info {
            padding: 8px;
            font-size: 10px;
            color: rgba(255, 255, 255, 0.6);
        }

        .photo-size {
            margin-bottom: 4px;
        }

        .photo-status {
            color: var(--accent-color);
            font-size: 9px;
        }

        .photo-actions {
            display: flex;
            gap: 5px;
            margin-top: 8px;
        }

        .photo-action-btn {
            flex: 1;
            padding: 6px 4px;
            font-size: 9px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.7);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .photo-action-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .photo-action-btn.add-scene {
            border-color: var(--accent-color);
            color: var(--accent-color);
        }

        .photo-action-btn.add-scene:hover {
            background: rgba(0, 255, 204, 0.1);
        }

        .photo-action-btn.remove-scene {
            border-color: #ffaa00;
            color: #ffaa00;
        }

        .photo-action-btn.delete {
            border-color: #ff4444;
            color: #ff4444;
        }

        .photo-action-btn.delete:hover {
            background: rgba(255, 68, 68, 0.1);
        }

        .modal-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.3);
        }

        .modal-action-btn {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 8px 14px;
            font-size: 11px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.8);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .modal-action-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.4);
            color: #fff;
        }

        .modal-action-btn.upload {
            border-color: var(--accent-color);
            color: var(--accent-color);
        }

        .modal-action-btn.upload:hover {
            background: rgba(0, 255, 204, 0.1);
        }

        .modal-action-btn.import {
            border-color: #88aaff;
            color: #88aaff;
        }

        .modal-action-btn.import:hover {
            background: rgba(136, 170, 255, 0.1);
        }

        .modal-action-btn.export {
            border-color: #ffaa00;
            color: #ffaa00;
        }

        .modal-action-btn.export:hover {
            background: rgba(255, 170, 0, 0.1);
        }

        .cache-stats {
            color: rgba(255, 255, 255, 0.6);
            font-size: 12px;
        }

        .cache-stats .highlight {
            color: var(--accent-color);
        }

        .cache-stats .warning {
            color: #ffaa00;
        }

        .clear-all-btn {
            padding: 8px 16px;
            font-size: 11px;
            background: rgba(255, 68, 68, 0.1);
            border: 1px solid #ff4444;
            color: #ff4444;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .clear-all-btn:hover {
            background: rgba(255, 68, 68, 0.2);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: rgba(255, 255, 255, 0.4);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        /* ÂØºÂá∫ÂëΩÂêçÂØπËØùÊ°ÜÊ†∑Âºè */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
            margin-bottom: 5px;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: #fff;
            font-size: 14px;
            box-sizing: border-box;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .form-group input[readonly] {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .filename-preview {
            padding: 10px;
            background: rgba(var(--accent-color-rgb), 0.1);
            border-radius: 6px;
            color: var(--accent-color);
            font-size: 12px;
            word-break: break-all;
        }

        /* Èü≥‰πêÁÆ°ÁêÜÊ†∑Âºè */
        .music-source-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .music-tab {
            flex: 1;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .music-tab:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.4);
        }

        .music-tab.active {
            background: rgba(var(--accent-color-rgb), 0.1);
            border-color: var(--accent-color);
            color: var(--accent-color);
        }

        .music-tab-content {
            padding: 15px 0;
        }

        .upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            border-color: var(--accent-color);
            background: rgba(var(--accent-color-rgb), 0.05);
        }

        .upload-area.dragover {
            border-color: var(--accent-color);
            background: rgba(var(--accent-color-rgb), 0.1);
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .upload-text {
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            margin-bottom: 8px;
        }

        .upload-hint {
            color: rgba(255, 255, 255, 0.4);
            font-size: 11px;
        }

        .current-music-info {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .music-info-label {
            color: rgba(255, 255, 255, 0.5);
            font-size: 11px;
            margin-bottom: 5px;
        }

        .music-info-value {
            color: var(--accent-color);
            font-size: 13px;
            word-break: break-all;
        }

        .music-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
        }

        .music-control-btn {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .music-control-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--accent-color);
            color: var(--accent-color);
        }

        .music-control-btn.playing {
            background: rgba(var(--accent-color-rgb), 0.1);
            border-color: var(--accent-color);
            color: var(--accent-color);
        }

        .volume-control {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            justify-content: flex-end;
        }

        .volume-label {
            font-size: 16px;
        }

        .volume-value {
            color: rgba(255, 255, 255, 0.6);
            font-size: 11px;
            min-width: 35px;
        }

        #music-volume {
            width: 100px;
            height: 4px;
            -webkit-appearance: none;
            appearance: none;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            outline: none;
        }

        #music-volume::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 14px;
            height: 14px;
            background: var(--accent-color);
            border-radius: 50%;
            cursor: pointer;
        }

        #music-volume::-moz-range-thumb {
            width: 14px;
            height: 14px;
            background: var(--accent-color);
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        /* ========== Èü≥‰πêÊí≠ÊîæÂä®ÊïàÊ†∑Âºè ========== */
        .music-widget {
            position: fixed;
            left: 20px;
            top: 30px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 25px;
            z-index: 100;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .music-widget-main {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        .music-visualizer {
            display: flex;
            align-items: flex-end;
            gap: 2px;
            height: 20px;
        }

        .music-visualizer .bar {
            width: 3px;
            background: linear-gradient(to top, var(--accent-color), var(--accent-color-light, #88ccff));
            border-radius: 2px;
            animation: musicBar 0.5s ease-in-out infinite alternate;
        }

        .music-visualizer .bar:nth-child(1) {
            height: 6px;
            animation-delay: 0s;
        }

        .music-visualizer .bar:nth-child(2) {
            height: 12px;
            animation-delay: 0.1s;
        }

        .music-visualizer .bar:nth-child(3) {
            height: 18px;
            animation-delay: 0.2s;
        }

        .music-visualizer .bar:nth-child(4) {
            height: 10px;
            animation-delay: 0.3s;
        }

        .music-visualizer .bar:nth-child(5) {
            height: 14px;
            animation-delay: 0.4s;
        }

        .music-visualizer.paused .bar {
            animation: none;
            height: 4px !important;
            opacity: 0.5;
        }

        .music-name {
            color: rgba(255, 255, 255, 0.9);
            font-size: 12px;
            max-width: 150px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .music-widget-controls {
            display: flex;
            gap: 4px;
            opacity: 0;
            max-width: 0;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .music-widget:hover .music-widget-controls {
            opacity: 1;
            max-width: 120px;
            margin-left: 8px;
        }

        .widget-btn {
            width: 28px;
            height: 28px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .widget-btn:hover {
            background: rgba(0, 255, 204, 0.3);
            color: #fff;
            transform: scale(1.1);
        }

        @keyframes musicBar {
            0% {
                transform: scaleY(0.3);
            }

            100% {
                transform: scaleY(1);
            }
        }

        /* ========== ÂºÄÂÖ≥Ê†∑Âºè ========== */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.2);
            transition: 0.3s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        .toggle-switch input:checked+.toggle-slider {
            background-color: var(--accent-color);
        }

        .toggle-switch input:checked+.toggle-slider:before {
            transform: translateX(20px);
        }

        /* ========== ÈÖçÁΩÆÈù¢ÊùøÊ†∑Âºè ========== */
        .settings-modal-content {
            max-width: 700px !important;
            width: 95%;
        }

        .settings-modal-content .modal-body {
            max-height: 70vh;
            overflow-y: auto;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .settings-section {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 12px;
        }

        .settings-section-wide {
            grid-column: span 3;
        }

        /* È¢úËâ≤ËÆæÁΩÆÊ†∑Âºè */
        .color-settings-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px 20px;
        }

        .color-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: 10px 8px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .color-item label {
            color: rgba(255, 255, 255, 0.8);
            font-size: 11px;
            text-align: center;
        }

        .color-item input[type="color"] {
            width: 40px;
            height: 40px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: transparent;
            cursor: pointer;
            padding: 0;
        }

        .color-item input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 3px;
        }

        .color-item input[type="color"]::-webkit-color-swatch {
            border-radius: 5px;
            border: none;
        }

        .color-item input[type="color"]:hover {
            border-color: var(--accent-color);
            box-shadow: 0 0 8px rgba(var(--accent-color-rgb), 0.3);
        }

        /* ‰∏ªÈ¢òÊåâÈíÆÊ†∑Âºè */
        .theme-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .theme-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 90px;
        }

        .theme-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .theme-btn.active {
            border-color: var(--accent-color);
            background: rgba(var(--accent-color-rgb), 0.1);
            box-shadow: 0 0 15px rgba(var(--accent-color-rgb), 0.3);
        }

        .theme-btn[data-theme="frozen"].active {
            border-color: #88ccff;
            background: rgba(136, 204, 255, 0.15);
            box-shadow: 0 0 15px rgba(136, 204, 255, 0.4);
        }

        .theme-btn[data-theme="golden"].active {
            border-color: #ffd700;
            background: rgba(255, 215, 0, 0.15);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
        }

        .theme-btn[data-theme="classic"].active {
            border-color: #ff4444;
            background: rgba(255, 68, 68, 0.15);
            box-shadow: 0 0 15px rgba(255, 68, 68, 0.4);
        }

        .theme-icon {
            font-size: 24px;
        }

        .theme-name {
            color: rgba(255, 255, 255, 0.8);
            font-size: 11px;
            font-weight: 500;
        }

        .theme-btn.active .theme-name {
            color: #fff;
        }

        .section-title {
            color: var(--accent-color);
            font-size: 13px;
            font-weight: bold;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .setting-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .setting-item:last-child {
            margin-bottom: 0;
        }

        .setting-item label {
            flex: 1;
            color: rgba(255, 255, 255, 0.7);
            font-size: 11px;
            min-width: 80px;
        }

        .setting-item input[type="range"] {
            flex: 2;
            height: 4px;
            -webkit-appearance: none;
            appearance: none;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            outline: none;
        }

        .setting-item input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 14px;
            height: 14px;
            background: var(--accent-color);
            border-radius: 50%;
            cursor: pointer;
        }

        .setting-item input[type="range"]::-moz-range-thumb {
            width: 14px;
            height: 14px;
            background: var(--accent-color);
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        .setting-value {
            min-width: 35px;
            text-align: right;
            color: var(--accent-color);
            font-size: 11px;
            font-family: monospace;
        }

        /* ========== ÁßªÂä®Á´ØÈÄÇÈÖç ========== */
        @media screen and (max-width: 768px) {

            /* Ê†áÈ¢òÈÄÇÈÖç */
            h1 {
                top: 15px;
                font-size: 22px;
                padding: 0 10px;
            }

            /* ÊåâÈíÆÂå∫Âüü - Âè≥‰∏äËßíÁ´ñÂêëÊéíÂàóÂ∞èÂõæÊ†á */
            .upload-wrapper {
                top: 10px;
                right: 10px;
                left: auto;
                transform: none;
                gap: 8px;
                flex-direction: column;
                flex-wrap: nowrap;
                justify-content: flex-start;
                align-items: flex-end;
            }

            .upload-btn,
            .control-btn {
                padding: 8px;
                font-size: 14px;
                gap: 0;
                border-radius: 50%;
                width: 36px;
                height: 36px;
                min-width: 36px;
            }

            /* ÁßªÂä®Á´ØÈöêËóèÊåâÈíÆÊñáÂ≠óÔºåÂè™ÊòæÁ§∫ÂõæÊ†á */
            .control-btn .btn-text {
                display: none;
            }

            .control-btn .btn-icon {
                font-size: 16px;
                color: rgba(255, 255, 255, 0.8);
            }

            .mobile-ctrl-btn i {
                font-size: 18px;
            }

            /* Êìç‰ΩúÊèêÁ§∫ - ÁßªÂä®Á´ØÈöêËóèÔºåÂõ†‰∏∫ÊúâÂ∫ïÈÉ®Ëß¶Êë∏ÊåâÈíÆ */
            #tips {
                display: none;
            }

            /* ÊëÑÂÉèÂ§¥È¢ÑËßà - ÁßªÂä®Á´ØÁº©Â∞èÂπ∂ÁßªÂà∞Â∑¶‰∏äËßí */
            #webcam-wrapper {
                width: 100px;
                height: 75px;
                top: 60px;
                left: 10px;
                bottom: auto;
                right: auto;
            }

            /* Ê®°ÊÄÅÊ°ÜÈÄÇÈÖç */
            .modal-content {
                width: 95%;
                max-height: 90vh;
                border-radius: 8px;
            }

            .modal-header {
                padding: 15px;
                flex-wrap: wrap;
            }

            .modal-header h2 {
                font-size: 16px;
                width: 100%;
                margin-bottom: 10px;
            }

            .header-actions {
                margin-left: 0;
                margin-right: 0;
                width: 100%;
                justify-content: flex-start;
                flex-wrap: wrap;
                gap: 6px;
            }

            .modal-action-btn {
                padding: 8px 10px;
                font-size: 10px;
            }

            .modal-body {
                padding: 15px;
            }

            .photo-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                gap: 10px;
            }

            .photo-info {
                padding: 6px;
                font-size: 9px;
            }

            .photo-action-btn {
                padding: 5px 3px;
                font-size: 8px;
            }

            /* ÈÖçÁΩÆÈù¢ÊùøÁßªÂä®Á´ØÈÄÇÈÖç */
            .settings-modal-content {
                max-width: 95% !important;
            }

            .settings-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            .settings-section {
                padding: 8px;
            }

            .settings-section-wide {
                grid-column: span 2;
            }

            /* ‰∏ªÈ¢òÊåâÈíÆÁßªÂä®Á´ØÈÄÇÈÖç */
            .theme-buttons {
                gap: 6px;
            }

            .theme-btn {
                padding: 8px 10px;
                min-width: 70px;
            }

            .theme-icon {
                font-size: 20px;
            }

            .theme-name {
                font-size: 10px;
            }

            .section-title {
                font-size: 11px;
                margin-bottom: 8px;
            }

            .setting-item {
                flex-wrap: wrap;
                gap: 5px;
            }

            .setting-item label {
                width: 100%;
                font-size: 10px;
                margin-bottom: 2px;
            }

            .setting-item input[type="range"] {
                flex: 1;
            }

            .setting-value {
                min-width: 30px;
            }

            .color-settings-row {
                gap: 10px;
            }

            .color-item {
                flex: 1;
                min-width: 70px;
            }

            .color-item label {
                font-size: 10px;
                min-width: 35px;
                font-size: 10px;
            }

            .modal-footer {
                padding: 12px 15px;
                flex-direction: column;
                gap: 10px;
            }

            .cache-stats {
                font-size: 11px;
                text-align: center;
            }

            /* Èü≥‰πêÊéßÂà∂ÈÄÇÈÖç */
            .music-controls {
                flex-wrap: wrap;
                gap: 8px;
            }

            .music-control-btn {
                padding: 8px 15px;
                font-size: 11px;
            }

            .volume-control {
                width: 100%;
                justify-content: center;
                margin-top: 5px;
            }

            #music-volume {
                width: 150px;
            }

            .music-source-tabs {
                flex-direction: column;
                gap: 8px;
            }

            .upload-area {
                padding: 30px 15px;
            }

            .upload-icon {
                font-size: 36px;
            }

            .upload-text {
                font-size: 13px;
            }

            /* Ë°®ÂçïÈÄÇÈÖç */
            .form-group input {
                padding: 12px;
                font-size: 16px;
                /* Èò≤Ê≠¢iOSÁº©Êîæ */
            }

            /* Èü≥‰πêÂä®ÊïàÁßªÂä®Á´ØÈÄÇÈÖç */
            .music-widget {
                left: 10px;
                top: 10px;
                padding: 6px 10px;
            }

            .music-name {
                max-width: 0;
                opacity: 0;
                font-size: 11px;
                overflow: hidden;
                transition: all 0.3s ease;
            }

            .music-widget.expanded .music-name {
                max-width: 100px;
                opacity: 1;
            }

            .music-widget-controls {
                display: flex;
                opacity: 0;
                max-width: 0;
                overflow: hidden;
                transition: all 0.3s ease;
            }

            .music-widget.expanded .music-widget-controls {
                opacity: 1;
                max-width: 100px;
                margin-left: 5px;
            }

            .widget-btn {
                width: 24px;
                height: 24px;
                font-size: 10px;
            }
        }

        /* Êõ¥Â∞èÂ±èÂπïÈÄÇÈÖç */
        @media screen and (max-width: 480px) {
            h1 {
                top: 15px;
                font-size: 20px;
            }

            .upload-wrapper {
                top: 10px;
                right: 10px;
            }

            .upload-btn,
            .control-btn {
                padding: 6px 10px;
                font-size: 10px;
            }

            #tips {
                font-size: 10px;
                padding: 10px;
            }

            .photo-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* ÁßªÂä®Á´ØËß¶Êë∏ÊéßÂà∂ÊåâÈíÆ */
        #mobile-controls {
            display: none;
            position: fixed;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 25;
            gap: 12px;
            pointer-events: auto;
        }

        @media screen and (max-width: 768px) {
            #mobile-controls {
                display: flex;
            }

            /* ÁßªÂä®Á´ØÈöêËóèÈîÆÁõòÊèêÁ§∫ */
            #tips .keyboard-tips {
                display: none;
            }
        }

        .mobile-ctrl-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: #fff;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            cursor: pointer;
            transition: all 0.3s ease;
            -webkit-tap-highlight-color: transparent;
        }

        .mobile-ctrl-btn:active {
            transform: scale(0.95);
            background: rgba(var(--accent-color-rgb), 0.3);
            border-color: var(--accent-color);
        }

        .mobile-ctrl-btn.active {
            background: rgba(var(--accent-color-rgb), 0.2);
            border-color: var(--accent-color);
            color: var(--accent-color);
        }

        /* ÂÆâÂÖ®Âå∫ÂüüÈÄÇÈÖç (iPhone X+) */
        @supports (padding: max(0px)) {
            #tips {
                padding-bottom: max(12px, env(safe-area-inset-bottom));
            }

            #mobile-controls {
                bottom: max(50px, calc(50px + env(safe-area-inset-bottom)));
            }
        }
    </style>
    <script type="importmap">
        {
            "imports": {
                "three": "https://testingcf.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://testingcf.jsdelivr.net/npm/three@0.160.0/examples/jsm/",
                "@mediapipe/tasks-vision": "https://testingcf.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/+esm"
            }
        }
    </script>
    <!-- Font Awesome ÂõæÊ†áÂ∫ì -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>

<body></body>
<div id="loader">
    <div class="spinner"></div>
    <div class="loader-text">Loading...</div>
</div>

<div id="canvas-container"></div>

<div id="ui-layer">
    <h1>Merry Christmas</h1>
    <div class="upload-wrapper">
        <button class="control-btn" id="manage-btn" title="ÁÆ°ÁêÜÁºìÂ≠òÁÖßÁâá"><i class="btn-icon fa-solid fa-folder-open"></i><span
                class="btn-text">ÁÆ°ÁêÜ</span></button>
        <button class="control-btn" id="music-btn" title="Êí≠Êîæ/ÊöÇÂÅúÈü≥‰πê"><i class="btn-icon fa-solid fa-music"></i><span
                class="btn-text">Èü≥‰πê</span></button>
        <button class="control-btn" id="settings-btn" title="ÂèÇÊï∞ËÆæÁΩÆ"><i class="btn-icon fa-solid fa-gear"></i><span
                class="btn-text">ËÆæÁΩÆ</span></button>
    </div>
    <!-- ÁßªÂä®Á´ØËß¶Êë∏ÊéßÂà∂ÊåâÈíÆ -->
    <div id="mobile-controls">
        <button class="mobile-ctrl-btn" id="mobile-tree" title="Âú£ËØûÊ†ëÊ®°Âºè"><i class="fa-solid fa-tree"></i></button>
        <button class="mobile-ctrl-btn" id="mobile-scatter" title="ÊòüÊ≤≥Êï£ÂºÄ"><i class="fa-solid fa-star"></i></button>
        <button class="mobile-ctrl-btn" id="mobile-photo" title="ÈîÅÂÆöÁÖßÁâá"><i class="fa-solid fa-image"></i></button>
        <button class="mobile-ctrl-btn" id="mobile-next" title="‰∏ã‰∏ÄÂº†"><i class="fa-solid fa-forward"></i></button>
    </div>
</div>

<!-- ËÉåÊôØÈü≥‰πê -->
<audio id="bg-music"></audio>

<!-- Èü≥‰πêÊí≠ÊîæÂä®Êïà -->
<div id="music-widget" class="music-widget">
    <div class="music-widget-main">
        <div id="music-visualizer" class="music-visualizer paused">
            <div class="bar"></div>
            <div class="bar"></div>
            <div class="bar"></div>
            <div class="bar"></div>
            <div class="bar"></div>
        </div>
        <div class="music-name" id="music-widget-name">Christmas Background</div>
    </div>
    <div class="music-widget-controls">
        <button class="widget-btn" id="widget-play-btn" title="Êí≠Êîæ/ÊöÇÂÅú">‚è∏</button>
        <button class="widget-btn" id="widget-next-btn" title="‰∏ã‰∏ÄÈ¶ñ">‚è≠</button>
        <button class="widget-btn" id="widget-settings-btn" title="Èü≥‰πêËÆæÁΩÆ">‚öô</button>
    </div>
</div>

<div id="webcam-wrapper">
    <video id="webcam" autoplay playsinline style="display:none;"></video>
    <canvas id="webcam-preview"></canvas>
</div>

<!-- ÁºìÂ≠òÁÆ°ÁêÜÊ®°ÊÄÅÊ°Ü -->
<div id="cache-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h2>ÁÖßÁâáÁºìÂ≠òÁÆ°ÁêÜ</h2>
            <div class="header-actions">
                <label class="modal-action-btn upload">
                    üì∑ ‰∏ä‰º†ÁÖßÁâá
                    <input type="file" id="file-input" multiple accept="image/*" style="display:none;">
                </label>
                <label class="modal-action-btn import">
                    üì• ÂØºÂÖ•
                    <input type="file" id="import-input" accept=".json" style="display:none;">
                </label>
                <button class="modal-action-btn export" id="export-btn">üì§ ÂØºÂá∫</button>
            </div>
            <button class="modal-close" id="modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <div id="photo-grid" class="photo-grid"></div>
        </div>
        <div class="modal-footer">
            <div class="cache-stats" id="cache-stats">
                Â∑≤ÁºìÂ≠ò <span class="highlight">0</span> Âº†ÁÖßÁâá (<span class="highlight">0 KB</span> / 50 MB)
            </div>
            <button class="clear-all-btn" id="clear-all-btn">Ê∏ÖÁ©∫ÂÖ®ÈÉ®</button>
        </div>
    </div>
</div>

<!-- ÂØºÂá∫ÂëΩÂêçÂØπËØùÊ°Ü -->
<div id="export-name-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <h2>ÂØºÂá∫ÁÖßÁâá</h2>
            <button class="modal-close" id="export-name-close">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>‰∏ªÈ¢òÂêç</label>
                <input type="text" id="export-theme" value="Merry Christmas">
            </div>
            <div class="form-group">
                <label>Ëá™ÂÆö‰πâÂêçÁß∞</label>
                <input type="text" id="export-custom" placeholder="‰æãÔºöÂ•≥ÊúãÂèãÈùìÁÖßÂêàÈõÜ">
            </div>
            <div class="form-group">
                <label>Êó•Êúü</label>
                <input type="text" id="export-date" readonly>
            </div>
            <div class="filename-preview">
                È¢ÑËßà: <span id="filename-preview"></span>
            </div>
        </div>
        <div class="modal-footer">
            <button class="modal-action-btn" id="export-cancel">ÂèñÊ∂à</button>
            <button class="modal-action-btn export" id="export-confirm">Á°ÆËÆ§ÂØºÂá∫</button>
        </div>
    </div>
</div>

<!-- Èü≥‰πêÁÆ°ÁêÜÂØπËØùÊ°Ü -->
<div id="music-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h2>üéµ Èü≥‰πêÁÆ°ÁêÜ</h2>
            <button class="modal-close" id="music-modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <div class="music-source-tabs">
                <button class="music-tab active" data-tab="url">üîó Èü≥‰πêÈìæÊé•</button>
                <button class="music-tab" data-tab="upload">üìÅ ‰∏ä‰º†Êñá‰ª∂</button>
            </div>

            <div class="music-tab-content" id="tab-url">
                <div class="form-group">
                    <label>ËæìÂÖ•Èü≥‰πêÈìæÊé• (ÊîØÊåÅ MP3, WAV, OGG Á≠âÊ†ºÂºè)</label>
                    <input type="text" id="music-url-input" placeholder="https://example.com/music.mp3">
                </div>
                <button class="modal-action-btn upload" id="apply-url-btn" style="width: 100%;">Â∫îÁî®ÈìæÊé•</button>
            </div>

            <div class="music-tab-content" id="tab-upload" style="display: none;">
                <div class="form-group">
                    <label>ÈÄâÊã©Êú¨Âú∞Èü≥È¢ëÊñá‰ª∂</label>
                    <div class="upload-area" id="music-upload-area">
                        <div class="upload-icon">üéµ</div>
                        <div class="upload-text">ÁÇπÂáªÊàñÊãñÊãΩÈü≥È¢ëÊñá‰ª∂Âà∞ËøôÈáå</div>
                        <div class="upload-hint">ÊîØÊåÅ MP3, WAV, OGG, M4A Ê†ºÂºè</div>
                        <input type="file" id="music-file-input" accept="audio/*" style="display: none;">
                    </div>
                </div>
            </div>

            <div class="current-music-info" id="current-music-info">
                <div class="music-info-label">ÂΩìÂâçÈü≥‰πê:</div>
                <div class="music-info-value" id="current-music-name">ÈªòËÆ§Èü≥‰πê</div>
            </div>

            <div class="music-controls">
                <button class="music-control-btn" id="music-play-btn">‚ñ∂ Êí≠Êîæ</button>
                <button class="music-control-btn" id="music-pause-btn">‚è∏ ÊöÇÂÅú</button>
                <button class="music-control-btn" id="music-next-btn">‚è≠ ‰∏ã‰∏ÄÈ¶ñ</button>
                <div class="volume-control"></div>
                <span class="volume-label">üîä</span>
                <input type="range" id="music-volume" min="0" max="100" value="50">
                <span class="volume-value" id="volume-value">50%</span>
            </div>
        </div>
    </div>
    <div class="modal-footer">
        <button class="modal-action-btn" id="music-reset-btn">üîÑ ÊÅ¢Â§çÈªòËÆ§</button>
        <button class="modal-action-btn export" id="music-close-btn">ÂÆåÊàê</button>
    </div>
</div>
</div>

<!-- ÈÖçÁΩÆÈù¢ÊùøÊ®°ÊÄÅÊ°Ü -->
<div id="settings-modal" class="modal-overlay">
    <div class="modal-content settings-modal-content">
        <div class="modal-header">
            <h2>‚öôÔ∏è ÂèÇÊï∞ËÆæÁΩÆ</h2>
            <button class="modal-close" id="settings-close">&times;</button>
        </div>
        <div class="modal-body">
            <div class="settings-grid">
                <!-- Áõ∏Êú∫ËÆæÁΩÆ -->
                <div class="settings-section">
                    <div class="section-title">üì∑ Áõ∏Êú∫</div>
                    <div class="setting-item">
                        <label>Ê†ëÊ®°ÂºèË∑ùÁ¶ª</label>
                        <input type="range" id="cfg-tree-distance" min="20" max="80" value="45">
                        <span class="setting-value" id="cfg-tree-distance-val">45</span>
                    </div>
                    <div class="setting-item">
                        <label>Êï£ÂºÄË∑ùÁ¶ª</label>
                        <input type="range" id="cfg-scatter-distance" min="25" max="80" value="55">
                        <span class="setting-value" id="cfg-scatter-distance-val">55</span>
                    </div>
                    <div class="setting-item">
                        <label>ËÅöÁÑ¶Ë∑ùÁ¶ª</label>
                        <input type="range" id="cfg-focus-distance" min="4" max="15" value="8">
                        <span class="setting-value" id="cfg-focus-distance-val">8</span>
                    </div>
                </div>
                <!-- ÊóãËΩ¨ËÆæÁΩÆ -->
                <div class="settings-section">
                    <div class="section-title">üîÑ ÊóãËΩ¨</div>
                    <div class="setting-item">
                        <label>Ê†ëÊ®°ÂºèÈÄüÂ∫¶</label>
                        <input type="range" id="cfg-tree-rotate" min="0" max="100" value="30">
                        <span class="setting-value" id="cfg-tree-rotate-val">0.3</span>
                    </div>
                    <div class="setting-item">
                        <label>Êï£ÂºÄÈÄüÂ∫¶</label>
                        <input type="range" id="cfg-scatter-rotate" min="0" max="50" value="5">
                        <span class="setting-value" id="cfg-scatter-rotate-val">0.05</span>
                    </div>
                </div>
                <!-- ÂèëÂÖâËÆæÁΩÆ -->
                <div class="settings-section">
                    <div class="section-title">‚ú® ÂèëÂÖâ</div>
                    <div class="setting-item">
                        <label>Ê≥õÂÖâÂº∫Â∫¶</label>
                        <input type="range" id="cfg-bloom-strength" min="0" max="30" value="15">
                        <span class="setting-value" id="cfg-bloom-strength-val">1.5</span>
                    </div>
                    <div class="setting-item">
                        <label>Ê≥õÂÖâÂçäÂæÑ</label>
                        <input type="range" id="cfg-bloom-radius" min="0" max="20" value="8">
                        <span class="setting-value" id="cfg-bloom-radius-val">0.8</span>
                    </div>
                </div>
                <!-- ÊòüÊòüËÆæÁΩÆ -->
                <div class="settings-section">
                    <div class="section-title">‚≠ê ÊòüÊòü</div>
                    <div class="setting-item">
                        <label>ÂèëÂÖâÂº∫Â∫¶</label>
                        <input type="range" id="cfg-star-glow" min="10" max="50" value="25">
                        <span class="setting-value" id="cfg-star-glow-val">2.5</span>
                    </div>
                    <div class="setting-item">
                        <label>Èó™ÁÉÅÈÄüÂ∫¶</label>
                        <input type="range" id="cfg-star-blink" min="1" max="20" value="8">
                        <span class="setting-value" id="cfg-star-blink-val">0.8</span>
                    </div>
                </div>
                <!-- Èõ™Ëä±ËÆæÁΩÆ -->
                <div class="settings-section">
                    <div class="section-title">‚ùÑÔ∏è Èõ™Ëä±</div>
                    <div class="setting-item">
                        <label>‰∏ãËêΩÈÄüÂ∫¶</label>
                        <input type="range" id="cfg-snow-speed" min="1" max="20" value="8">
                        <span class="setting-value" id="cfg-snow-speed-val">0.08</span>
                    </div>
                    <div class="setting-item">
                        <label>Èõ™Ëä±Â§ßÂ∞è</label>
                        <input type="range" id="cfg-snow-size" min="1" max="10" value="2">
                        <span class="setting-value" id="cfg-snow-size-val">0.2</span>
                    </div>
                    <div class="setting-item">
                        <label>Èõ™Ëä±Êï∞Èáè</label>
                        <input type="range" id="cfg-snow-count" min="100" max="3000" value="1000" step="100">
                        <span class="setting-value" id="cfg-snow-count-val">1000</span>
                    </div>
                </div>
                <!-- Ë£ÖÈ•∞ÁêÉËÆæÁΩÆ -->
                <div class="settings-section">
                    <div class="section-title">üîµ Ë£ÖÈ•∞ÁêÉ</div>
                    <div class="setting-item">
                        <label>‰∏ªËâ≤ÁêÉÊï∞Èáè</label>
                        <input type="range" id="cfg-ornament-count" min="100" max="600" value="400" step="10">
                        <span class="setting-value" id="cfg-ornament-count-val">400</span>
                    </div>
                    <div class="setting-item">
                        <label>ÂâØËâ≤ÁêÉÊï∞Èáè</label>
                        <input type="range" id="cfg-whiteball-count" min="50" max="300" value="150" step="10">
                        <span class="setting-value" id="cfg-whiteball-count-val">150</span>
                    </div>
                    <div class="setting-item">
                        <label>ÊñπÂùóÊï∞Èáè</label>
                        <input type="range" id="cfg-box-count" min="0" max="300" value="100" step="10">
                        <span class="setting-value" id="cfg-box-count-val">100</span>
                    </div>
                </div>
                <!-- ÁÖßÁâáËÆæÁΩÆ -->
                <div class="settings-section">
                    <div class="section-title">üñºÔ∏è ÁÖßÁâá</div>
                    <div class="setting-item">
                        <label>ÊîæÂ§ßÂÄçÊï∞</label>
                        <input type="range" id="cfg-photo-scale" min="10" max="50" value="25">
                        <span class="setting-value" id="cfg-photo-scale-val">2.5</span>
                    </div>
                </div>
                <!-- Èü≥‰πêËÆæÁΩÆ -->
                <div class="settings-section">
                    <div class="section-title">üéµ Èü≥‰πê</div>
                    <div class="setting-item">
                        <label>ËÉåÊôØÈü≥‰πê</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="cfg-music-enabled" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <label>Ëá™Âä®Êí≠Êîæ</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="cfg-music-autoplay" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                <!-- ‰∏ªÈ¢òÂàáÊç¢ -->
                <div class="settings-section settings-section-wide">
                    <div class="section-title">ÔøΩ ‰∏ªÈ¢òÈ£éÊ†º<i /div>
                            <div class="theme-buttons">
                                <button class="theme-btn active" data-theme="frozen" title="ÂÜ∞Èõ™Â•áÁºò">
                                    <span class="theme-icon">‚ùÑÔ∏è</span>
                                    <span class="theme-name">ÂÜ∞Èõ™Â•áÁºò</span>
                                </button>
                                <button class="theme-btn" data-theme="golden" title="ÁíÄÁí®ÈáëËæâ">
                                    <span class="theme-icon">‚ú®</span>
                                    <span class="theme-name">ÁíÄÁí®ÈáëËæâ</span>
                                </button>
                                <button class="theme-btn" data-theme="classic" title="ÁªèÂÖ∏Âú£ËØû">
                                    <span class="theme-icon">üéÖ</span>
                                    <span class="theme-name">ÁªèÂÖ∏Âú£ËØû</span>
                                </button>
                            </div>
                    </div>
                    <!-- È¢úËâ≤ËÆæÁΩÆ -->
                    <div class="settings-section settings-section-wide">
                        <div class="section-title">üé® È¢úËâ≤</div>
                        <div class="color-settings-row">
                            <div class="color-item">
                                <input type="color" id="cfg-ornament-color" value="#88ccff">
                                <label>Ë£ÖÈ•∞ÁêÉ</label>
                            </div>
                            <div class="color-item">
                                <input type="color" id="cfg-whiteball-color" value="#ffffff">
                                <label>ÁôΩËâ≤ÁêÉ</label>
                            </div>
                            <div class="color-item">
                                <input type="color" id="cfg-box-color" value="#051020">
                                <label>ÊñπÂùó</label>
                            </div>
                            <div class="color-item">
                                <input type="color" id="cfg-light-color" value="#0066ff">
                                <label>ÁÅØÂÖâ</label>
                            </div>
                            <div class="color-item">
                                <input type="color" id="cfg-star-color" value="#ffff00">
                                <label>ÊòüÊòü</label>
                            </div>
                            <div class="color-item">
                                <input type="color" id="cfg-snow-color" value="#ffffff">
                                <label>Èõ™Ëä±</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-action-btn" id="settings-reset">üîÑ ÊÅ¢Â§çÈªòËÆ§</button>
                <button class="modal-action-btn export" id="settings-apply">‚úì Â∫îÁî®</button>
            </div>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
        import { RoomEnvironment } from 'three/addons/environments/RoomEnvironment.js';
        import { RGBELoader } from 'three/addons/loaders/RGBELoader.js';
        import { FilesetResolver, HandLandmarker } from '@mediapipe/tasks-vision';

        // ÂÖ®Â±ÄÂèòÈáè
        let scene, camera, renderer, composer, bloomPass, mainGroup;
        let clock = new THREE.Clock();
        let particleSystem = [], photoMeshGroup = new THREE.Group();
        let handLandmarker, video, webcamCanvas, webcamCtx;
        let snowSystem;
        let photoDataArray = []; // Â≠òÂÇ®ÊâÄÊúâÁÖßÁâáÁöÑbase64Êï∞ÊçÆ
        let photoIdToMeshMap = new Map(); // ÁÖßÁâáIDÂà∞Âú∫ÊôØmeshÁöÑÊò†Â∞Ñ

        // HDRÂä†ËΩΩÁä∂ÊÄÅ
        let hdrLoaded = false;

        // ‰∏ªÈ¢òÈÖçËâ≤ÊñπÊ°à
        const THEMES = {
            // ÂÜ∞Èõ™Â•áÁºò - ËìùÁôΩÂÜ∞Èõ™È£éÊ†º
            frozen: {
                name: 'ÂÜ∞Èõ™Â•áÁºò',
                ornamentColor: '#88ccff',    // ÂÜ∞ËìùËâ≤Ë£ÖÈ•∞ÁêÉ
                whiteBallColor: '#ffffff',   // Á∫ØÁôΩËâ≤ÁêÉ
                boxColor: '#051020',         // Ê∑±ËìùËâ≤ÊñπÂùó
                lightColor: '#0066ff',       // ËìùËâ≤ÁÅØÂÖâ
                starColor: '#ffff00',        // ÈáëÈªÑËâ≤ÊòüÊòü
                snowColor: '#ffffff',        // ÁôΩËâ≤Èõ™Ëä±
                bgGradient: ['#0b1a2a', '#000000'],  // ËÉåÊôØÊ∏êÂèò
                titleGradient: ['#e0f7fa', '#ffffff', '#88ccff'],  // Ê†áÈ¢òÊ∏êÂèò
                accentColor: '#00ffcc',      // Âº∫Ë∞ÉËâ≤
                // HDRÂä†ËΩΩÊàêÂäüÊó∂ÁöÑÊ≥õÂÖâÂèÇÊï∞
                bloomStrengthHDR: 0.2,
                bloomRadiusHDR: 0.1,
                // HDRÂä†ËΩΩÂ§±Ë¥•Êó∂ÁöÑÊ≥õÂÖâÂèÇÊï∞ÔºàÈªòËÆ§ÂÄºÔºâ
                bloomStrength: 0.9,
                bloomRadius: 0.5
            },
            // ÁíÄÁí®ÈáëËæâ - ÈáëËâ≤Â•¢ÂçéÈ£éÊ†º (demoÂêåÊ¨æÈÖçËâ≤)
            golden: {
                name: 'ÁíÄÁí®ÈáëËæâ',
                ornamentColor: '#c09e30',    // Ê∑±ÈáëËâ≤Ë£ÖÈ•∞ÁêÉ (demoÂêåÊ¨æ)
                whiteBallColor: '#a6202d',   // ÊöóÁ∫¢Ëâ≤ÁêÉ (demoÂêåÊ¨æ)
                boxColor: '#967d2a',         // Ê∑±ÁªøËâ≤ÊñπÂùó (demoÂêåÊ¨æ)
                lightColor: '#FFD700',       // Á∫ØÈáëËâ≤ÁÅØÂÖâ (demoÂêåÊ¨æ)
                starColor: '#FFD700',        // ÈáëËâ≤ÊòüÊòü (demoÂêåÊ¨æ)
                snowColor: '#F5E6BF',        // ÊµÖÈáëËâ≤Èõ™Ëä± (demoÂêåÊ¨æ)
                bgGradient: ['#0a0a05', '#000000'],  // Ê∑±Ëâ≤ËÉåÊôØÊ∏êÂèò
                titleGradient: ['#D4AF37', '#F5E6BF', '#D4AF37'],  // Ê†áÈ¢òÊ∏êÂèò (demoÂêåÊ¨æ)
                accentColor: '#D4AF37',      // Âº∫Ë∞ÉËâ≤ (demoÂêåÊ¨æ)
                // HDRÂä†ËΩΩÊàêÂäüÊó∂ÁöÑÊ≥õÂÖâÂèÇÊï∞
                bloomStrengthHDR: 0.4,
                bloomRadiusHDR: 0.2,
                // HDRÂä†ËΩΩÂ§±Ë¥•Êó∂ÁöÑÊ≥õÂÖâÂèÇÊï∞ÔºàÈªòËÆ§ÂÄºÔºâ
                bloomStrength: 1.4,
                bloomRadius: 0.8
            },
            // ÁªèÂÖ∏Âú£ËØû - Á∫¢Áªø‰º†ÁªüÈ£éÊ†º
            classic: {
                name: 'ÁªèÂÖ∏Âú£ËØû',
                ornamentColor: '#b24c4c',    // Á∫¢Ëâ≤Ë£ÖÈ•∞ÁêÉ
                whiteBallColor: '#38c838',   // Ê£ÆÊûóÁªøËâ≤ÁêÉ
                boxColor: '#0a1a0a',         // Ê∑±ÁªøËâ≤ÊñπÂùó
                lightColor: '#ff6600',       // ÊöñÊ©ôËâ≤ÁÅØÂÖâ
                starColor: '#ffd700',        // ÈáëËâ≤ÊòüÊòü
                snowColor: '#ffffff',        // ÁôΩËâ≤Èõ™Ëä±
                bgGradient: ['#0a1a0a', '#000000'],  // ËÉåÊôØÊ∏êÂèò
                titleGradient: ['#ff4444', '#ffffff', '#228b22'],  // Ê†áÈ¢òÊ∏êÂèò
                accentColor: '#ff4444',      // Âº∫Ë∞ÉËâ≤
                // HDRÂä†ËΩΩÊàêÂäüÊó∂ÁöÑÊ≥õÂÖâÂèÇÊï∞
                bloomStrengthHDR: 0.6,
                bloomRadiusHDR: 0.2,
                // HDRÂä†ËΩΩÂ§±Ë¥•Êó∂ÁöÑÊ≥õÂÖâÂèÇÊï∞ÔºàÈªòËÆ§ÂÄºÔºâ
                bloomStrength: 1.8,
                bloomRadius: 1.0
            }
        };

        // ÂΩìÂâç‰∏ªÈ¢ò
        let currentTheme = 'frozen';

        // ÈÖçÁΩÆÂèÇÊï∞ÔºàÂèØÈÄöËøáËÆæÁΩÆÈù¢ÊùøË∞ÉÊï¥Ôºâ
        const CONFIG = {
            treeDistance: 45,
            scatterDistance: 55,
            focusDistance: 8,
            treeRotate: 0.3,
            scatterRotate: 0.1,
            bloomStrength: 0.9,
            bloomRadius: 0.5,
            starGlow: 3,
            starBlink: 1,
            snowSpeed: 0.03,
            snowSize: 0.2,
            snowCount: 1000,             // Èõ™Ëä±Êï∞Èáè
            photoScale: 2.5,
            // Êï∞ÈáèÈÖçÁΩÆ (ÂèÇËÄÉdemoË∞ÉÊï¥)
            ornamentCount: 400,          // Ë£ÖÈ•∞ÁêÉÊï∞ÈáèÔºàÂ¢ûÂä†ÔºåÊõ¥Á¥ßÂØÜÔºâ
            whiteBallCount: 150,         // ÁôΩËâ≤ÁêÉÊï∞ÈáèÔºàÂ¢ûÂä†Ôºâ
            boxCount: 250,               // ÊñπÂùóÊï∞ÈáèÔºàÂáèÂ∞ëÔºåÂèØË∞ÉËäÇÔºâ
            candyCount: 60,              // Á≥ñÊûúÊ£íÊï∞Èáè
            // ÁêÉ‰ΩìÂ§ßÂ∞èÈÖçÁΩÆ
            ballSizeMin: 0.3,            // ÁêÉÊúÄÂ∞èÂ∞∫ÂØ∏ÔºàÂ¢ûÂ§ßÔºâ
            ballSizeMax: 1.2,            // ÁêÉÊúÄÂ§ßÂ∞∫ÂØ∏ÔºàÂ¢ûÂ§ßÔºâ
            // È¢úËâ≤ÈÖçÁΩÆ
            ornamentColor: '#88ccff',    // Ë£ÖÈ•∞ÁêÉÈ¢úËâ≤
            whiteBallColor: '#ffffff',   // ÁôΩËâ≤ÁêÉÈ¢úËâ≤
            boxColor: '#051020',         // ÊñπÂùóÈ¢úËâ≤
            lightColor: '#0066ff',       // ÂÜÖÈÉ®ÁÅØÂÖâÈ¢úËâ≤
            starColor: '#ffff00',        // ÊòüÊòüÈ¢úËâ≤
            snowColor: '#ffffff'         // Èõ™Ëä±È¢úËâ≤
        };

        // ========== È¢ÑÁΩÆÁÖßÁâáÊï∞ÊçÆ ==========
        // ‰ΩøÁî®ÊñπÊ≥ïÔºöÂ∞ÜÂØºÂá∫ÁöÑJSONÊñá‰ª∂‰∏≠ÁöÑ photos Êï∞ÁªÑÂÜÖÂÆπÁ≤òË¥¥Âà∞‰∏ãÈù¢ÁöÑÊï∞ÁªÑ‰∏≠
        // Ê†ºÂºèÁ§∫‰æãÔºö["data:image/jpeg;base64,/9j/4AAQ...", "data:image/png;base64,iVBORw0..."]
        const PRESET_PHOTOS = [

        ]
        // ====================================

        // ÁºìÂ≠òÈÖçÁΩÆ
        const CACHE_CONFIG = {
            maxPhotos: 20,
            maxSizeMB: 50,
            dbName: 'ChristmasTreeDB',
            storeName: 'photos',
            // Èü≥‰πêÁºìÂ≠òÈÖçÁΩÆ
            musicStoreName: 'music',
            maxMusicSizeMB: 20
        };

        // IndexedDB Â∑•ÂÖ∑ÂáΩÊï∞
        const PhotoCache = {
            db: null,

            async init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(CACHE_CONFIG.dbName, 1);
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => {
                        this.db = request.result;
                        resolve();
                    };
                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains(CACHE_CONFIG.storeName)) {
                            const store = db.createObjectStore(CACHE_CONFIG.storeName, { keyPath: 'id' });
                            store.createIndex('timestamp', 'timestamp', { unique: false });
                        }
                    };
                });
            },

            async savePhoto(base64Data) {
                // Ê£ÄÊü•ÊòØÂê¶Ë∂ÖÂá∫ÈôêÂà∂
                const stats = await this.getStats();
                const newSize = this.getBase64Size(base64Data);

                if (stats.count >= CACHE_CONFIG.maxPhotos) {
                    return { success: false, reason: 'count', message: `Â∑≤ËææÂà∞ÊúÄÂ§ßÁºìÂ≠òÊï∞Èáè (${CACHE_CONFIG.maxPhotos} Âº†)ÔºåËØ∑ÂÖàÂà†Èô§‰∏Ä‰∫õÁÖßÁâá` };
                }

                if ((stats.totalSize + newSize) / (1024 * 1024) > CACHE_CONFIG.maxSizeMB) {
                    return { success: false, reason: 'size', message: `Â∑≤ËææÂà∞ÊúÄÂ§ßÁºìÂ≠òÂ§ßÂ∞è (${CACHE_CONFIG.maxSizeMB} MB)ÔºåËØ∑ÂÖàÂà†Èô§‰∏Ä‰∫õÁÖßÁâá` };
                }

                const photo = {
                    id: 'photo_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    base64: base64Data,
                    timestamp: Date.now(),
                    size: newSize,
                    inScene: true
                };

                return new Promise((resolve) => {
                    const tx = this.db.transaction(CACHE_CONFIG.storeName, 'readwrite');
                    const store = tx.objectStore(CACHE_CONFIG.storeName);
                    const request = store.add(photo);
                    request.onsuccess = () => resolve({ success: true, photo });
                    request.onerror = () => resolve({ success: false, reason: 'db', message: '‰øùÂ≠òÂ§±Ë¥•' });
                });
            },

            async getAllPhotos() {
                return new Promise((resolve) => {
                    const tx = this.db.transaction(CACHE_CONFIG.storeName, 'readonly');
                    const store = tx.objectStore(CACHE_CONFIG.storeName);
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result || []);
                    request.onerror = () => resolve([]);
                });
            },

            async deletePhoto(id) {
                return new Promise((resolve) => {
                    const tx = this.db.transaction(CACHE_CONFIG.storeName, 'readwrite');
                    const store = tx.objectStore(CACHE_CONFIG.storeName);
                    const request = store.delete(id);
                    request.onsuccess = () => resolve(true);
                    request.onerror = () => resolve(false);
                });
            },

            async updatePhoto(photo) {
                return new Promise((resolve) => {
                    const tx = this.db.transaction(CACHE_CONFIG.storeName, 'readwrite');
                    const store = tx.objectStore(CACHE_CONFIG.storeName);
                    const request = store.put(photo);
                    request.onsuccess = () => resolve(true);
                    request.onerror = () => resolve(false);
                });
            },

            async clearAll() {
                return new Promise((resolve) => {
                    const tx = this.db.transaction(CACHE_CONFIG.storeName, 'readwrite');
                    const store = tx.objectStore(CACHE_CONFIG.storeName);
                    const request = store.clear();
                    request.onsuccess = () => resolve(true);
                    request.onerror = () => resolve(false);
                });
            },

            async getStats() {
                const photos = await this.getAllPhotos();
                const totalSize = photos.reduce((sum, p) => sum + (p.size || 0), 0);
                return {
                    count: photos.length,
                    totalSize,
                    inSceneCount: photos.filter(p => p.inScene).length
                };
            },

            getBase64Size(base64) {
                // ËÆ°ÁÆóbase64Â≠óÁ¨¶‰∏≤ÁöÑÂÆûÈôÖÂ≠óËäÇÂ§ßÂ∞è
                const base64Length = base64.length - (base64.indexOf(',') + 1);
                const padding = (base64.match(/=+$/) || [''])[0].length;
                return Math.floor((base64Length * 3) / 4) - padding;
            },

            formatSize(bytes) {
                if (bytes < 1024) return bytes + ' B';
                if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
                return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
            }
        };

        // ÊùêË¥®ÂØπË±°
        const MATERIALS = {};

        // Áä∂ÊÄÅÁÆ°ÁêÜ
        const STATE = {
            mode: 'TREE', // TREE, SCATTER, FOCUS
            hand: { detected: false, x: 0, y: 0 },
            rotation: { x: 0, y: 0 },
            camera: {
                targetPos: new THREE.Vector3(0, 2, 50),
                targetLookAt: new THREE.Vector3(0, 0, 0),
                currentLookAt: new THREE.Vector3(0, 0, 0)
            },
            focusTarget: null,
            // Ëß¶Êë∏ÊçèÂêàÁº©ÊîæÁä∂ÊÄÅ
            pinch: {
                zoom: 1,
                offsetX: 0,
                offsetY: 0
            },
            // ÊâãÂäøÊçèÂêàÂπ≥ÁßªÁä∂ÊÄÅÔºàFOCUSÊ®°Âºè‰∏ãÔºâ
            handPinch: {
                active: false,
                offsetX: 0,
                offsetY: 0
            }
        };

        // ÂàùÂßãÂåñ Three.js
        function initThree() {
            const container = document.getElementById('canvas-container');

            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x111111, 0.02);

            camera = new THREE.PerspectiveCamera(42, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 3, 45);  // Ë∞ÉÊï¥Áõ∏Êú∫‰ΩçÁΩÆÔºåÁ®çÂæÆÂæÄ‰∏äÁúã

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            // ‰ºòÂåñËâ≤Ë∞ÉÊò†Â∞ÑÔºåÂ¢ûÂº∫ÈáëÂ±ûÂèçÂÖâÊïàÊûú
            renderer.toneMapping = THREE.ACESFilmicToneMapping;  // ÁîµÂΩ±Á∫ßËâ≤Ë∞ÉÊò†Â∞Ñ
            renderer.toneMappingExposure = 1.5;
            renderer.outputColorSpace = THREE.SRGBColorSpace;
            container.appendChild(renderer.domElement);

            // ÂàõÂª∫È´òË¥®ÈáèÁéØÂ¢ÉË¥¥Âõæ - ‰ΩøÁî®HDRÊñá‰ª∂
            const pmremGenerator = new THREE.PMREMGenerator(renderer);
            pmremGenerator.compileEquirectangularShader();

            // Âä†ËΩΩHDRÁéØÂ¢ÉË¥¥Âõæ
            const rgbeLoader = new RGBELoader();
            rgbeLoader.load(
                'blocky_photo_studio_1k.hdr',
                (texture) => {
                    const envMap = pmremGenerator.fromEquirectangular(texture).texture;
                    scene.environment = envMap;
                    texture.dispose();
                    pmremGenerator.dispose();
                    console.log('HDRÁéØÂ¢ÉË¥¥ÂõæÂä†ËΩΩÊàêÂäü');

                    // Ê†áËÆ∞HDRÂä†ËΩΩÊàêÂäüÔºåÂπ∂Â∫îÁî®ÂΩìÂâç‰∏ªÈ¢òÁöÑHDRÊ≥õÂÖâÂèÇÊï∞
                    hdrLoaded = true;
                    applyTheme(currentTheme);
                },
                undefined,
                (error) => {
                    console.warn('HDRÂä†ËΩΩÂ§±Ë¥•Ôºå‰ΩøÁî®ÈªòËÆ§ÁéØÂ¢É:', error);
                    // Â§±Ë¥•Êó∂‰ΩøÁî®ÈªòËÆ§ÁéØÂ¢É
                    const roomEnv = new RoomEnvironment();
                    const envTexture = pmremGenerator.fromScene(roomEnv, 0.5).texture;
                    scene.environment = envTexture;

                    // Ê†áËÆ∞HDRÂä†ËΩΩÂ§±Ë¥•Ôºå‰ΩøÁî®ÈªòËÆ§Ê≥õÂÖâÂèÇÊï∞
                    hdrLoaded = false;
                }
            );
            // ‰∏çËÆæÁΩÆËÉåÊôØÔºå‰øùÊåÅÈÄèÊòéÈªëËâ≤ËÉåÊôØ
            // scene.background = envTexture;

            // Ê∏ÖÁêÜPMREMÁîüÊàêÂô®
            pmremGenerator.dispose();

            mainGroup = new THREE.Group();
            scene.add(mainGroup);
        }

        // ÂàõÂª∫ÊùêË¥® (ÂèÇËÄÉdemoÁöÑ3DÊïàÊûúÔºåÂ¢ûÂº∫ÂèçÂ∞Ñ)
        function createMaterials() {
            // Ë£ÖÈ•∞ÁêÉÊùêË¥® - È´òÈáëÂ±ûÊÑü„ÄÅ‰ΩéÁ≤óÁ≥ôÂ∫¶ÔºåÂº∫ÂèçÂ∞Ñ
            MATERIALS.gold = new THREE.MeshStandardMaterial({
                color: 0x88ccff,
                metalness: 1.0,           // ÊúÄÈ´òÈáëÂ±ûÊÑü
                roughness: 0.05,          // Êõ¥‰ΩéÁ≤óÁ≥ôÂ∫¶ÔºåÊõ¥Âº∫ÂèçÂ∞Ñ
                envMapIntensity: 2.0,     // Â¢ûÂº∫ÁéØÂ¢ÉË¥¥ÂõæÂº∫Â∫¶
                emissive: 0x001122,
                emissiveIntensity: 0.1
            });

            // ÊñπÂùóÊùêË¥®
            MATERIALS.green = new THREE.MeshStandardMaterial({
                color: 0x051020,
                metalness: 0.5,
                roughness: 0.3,
                envMapIntensity: 1.0,
                emissive: 0x000510,
                emissiveIntensity: 0.2
            });

            // ÁôΩËâ≤ÁêÉ/Á¨¨‰∫åÁßçÁêÉÊùêË¥® - È´òÈáëÂ±ûÊÑüÔºåÂº∫ÂèçÂ∞Ñ
            MATERIALS.red = new THREE.MeshStandardMaterial({
                color: 0xffffff,
                metalness: 1.0,           // ÊúÄÈ´òÈáëÂ±ûÊÑü
                roughness: 0.05,          // Êõ¥‰ΩéÁ≤óÁ≥ôÂ∫¶ÔºåÊõ¥Âº∫ÂèçÂ∞Ñ
                envMapIntensity: 2.0,     // Â¢ûÂº∫ÁéØÂ¢ÉË¥¥ÂõæÂº∫Â∫¶
                emissive: 0x111111,
                emissiveIntensity: 0.05
            });

            MATERIALS.frame = new THREE.MeshBasicMaterial({ color: 0xffffff });

            // ÊòüÊòüÊùêË¥® - ÂèëÂÖâÊïàÊûú
            MATERIALS.star = new THREE.MeshStandardMaterial({
                color: 0xffff00,
                emissive: 0xFFD700,        // ÈáëËâ≤ÂèëÂÖâ (demoÂêåÊ¨æ)
                emissiveIntensity: 1.5,
                metalness: 0.9,
                roughness: 0.1,
                toneMapped: false
            });

            // Á≥ñÊûúÁ∫πÁêÜ
            const canvas = document.createElement('canvas');
            canvas.width = 128;
            canvas.height = 128;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#fff';
            ctx.fillRect(0, 0, 128, 128);
            ctx.fillStyle = '#0088ff';
            ctx.beginPath();
            for (let i = -128; i < 256; i += 32) {
                ctx.moveTo(i, 0);
                ctx.lineTo(i + 32, 128);
                ctx.lineTo(i + 16, 128);
                ctx.lineTo(i - 16, 0);
            }
            ctx.fill();
            const texture = new THREE.CanvasTexture(canvas);
            texture.wrapS = texture.wrapT = THREE.RepeatWrapping;
            texture.repeat.set(3, 3);
            MATERIALS.candy = new THREE.MeshStandardMaterial({ map: texture, roughness: 0.4 });
        }

        // ÁÅØÂÖâÂºïÁî®
        let innerLight;

        // ËÆæÁΩÆÁÅØÂÖâ (‰ºòÂåñÂèçÂÖâÊïàÊûúÔºåÂèÇËÄÉdemo)
        function setupLights() {
            // ÁéØÂ¢ÉÂÖâ - Êèê‰æõÂü∫Á°ÄÁÖßÊòé
            scene.add(new THREE.AmbientLight(0x004422, 0.3));  // Ê∑±ÁªøËâ≤ÁéØÂ¢ÉÂÖâ

            // ÂÜÖÈÉ®ÁÇπÂÖâÊ∫ê - Ê†ëÂÜÖÈÉ®ÂèëÂÖâ
            innerLight = new THREE.PointLight(0x0066ff, 2, 20);
            innerLight.position.set(0, 5, 0);
            mainGroup.add(innerLight);

            // ‰∏ªËÅöÂÖâÁÅØ - ‰ªéÂè≥‰∏äÊñπÁÖßÂ∞ÑÔºå‰∫ßÁîüÈ´òÂÖâ
            const spot1 = new THREE.SpotLight(0xfff5cc, 2);  // ÊöñÁôΩËâ≤
            spot1.position.set(10, 20, 10);
            spot1.angle = 0.3;
            spot1.penumbra = 1;
            spot1.castShadow = true;
            scene.add(spot1);

            // ËæÖÂä©ÁÇπÂÖâÊ∫ê - ÈáëËâ≤ÂÖâÔºåÂ¢ûÂº∫ÈáëÂ±ûÂèçÂÖâ
            const goldLight = new THREE.PointLight(0xD4AF37, 1.5, 50);
            goldLight.position.set(-10, 5, -10);
            scene.add(goldLight);

            // Â°´ÂÖÖÂÖâ - ‰ªéÊ≠£Èù¢ÁÖßÂ∞Ñ
            const fill = new THREE.DirectionalLight(0xffffff, 0.5);
            fill.position.set(0, 0, 50);
            scene.add(fill);

            // È°∂ÈÉ®ÂÖâ - ÁÖß‰∫ÆÊòüÊòü
            const topLight = new THREE.PointLight(0xFFD700, 2, 30);
            topLight.position.set(0, 15, 5);
            scene.add(topLight);
        }

        // Á≤íÂ≠êÁ±ª (ÂèÇËÄÉdemo‰ºòÂåñÂàÜÂ∏É)
        class Particle {
            constructor(mesh, type) {
                this.mesh = mesh;
                this.type = type;
                this.posTree = new THREE.Vector3();
                this.posScatter = new THREE.Vector3();
                this.baseScale = mesh.scale.x;
                this.spinSpeed = new THREE.Vector3(
                    Math.random() - 0.5,
                    Math.random() - 0.5,
                    Math.random() - 0.5
                ).multiplyScalar(type === 'PHOTO' ? 0.3 : 2.0);

                // Ê†ëÂΩ¢‰ΩçÁΩÆ (ÂèÇËÄÉdemoÁöÑÂàÜÂ∏ÉÁÆóÊ≥ï)
                const treeHeight = 18;   // Ê†ëÁöÑÈ´òÂ∫¶ÔºàÂ¢ûÈ´òÔºâ
                const baseRadius = 6;    // Â∫ïÈÉ®ÂçäÂæÑ
                const treeBaseY = -10;    // Ê†ëÂ∫ïÈÉ®ÁöÑYÂùêÊ†á

                // tÂÄºÂàÜÂ∏ÉÔºö‰ΩøÁî®Âπ≥ÊñπËÆ©Â∫ïÈÉ®Êõ¥ÂØÜÈõÜ
                const t = Math.pow(Math.random(), 1.5);
                const y = treeBaseY + t * treeHeight;  // ‰ªé-7Âà∞11

                // ÂçäÂæÑÈöèÈ´òÂ∫¶ÈÄíÂáèÔºåÂ∫ïÈÉ®Êõ¥ÂÆΩ
                const radiusFactor = 1 - t;
                const r = baseRadius * radiusFactor + Math.random() * 0.5;

                // ‰ΩøÁî®ÈªÑÈáëËßíÂ∫¶Ëû∫ÊóãÂàÜÂ∏É
                const goldenAngle = 2.39996;
                const a = goldenAngle * (Math.random() * 1000);

                this.posTree.set(Math.cos(a) * r, y, Math.sin(a) * r);

                // Êï£ÂºÄ‰ΩçÁΩÆ
                const rs = 12 + Math.random() * 25;
                const theta = Math.random() * Math.PI * 2;
                const phi = Math.acos(2 * Math.random() - 1);
                this.posScatter.set(
                    rs * Math.sin(phi) * Math.cos(theta),
                    rs * Math.sin(phi) * Math.sin(theta),
                    rs * Math.cos(phi)
                );
            }

            update(dt, mode) {
                let target = (mode === 'SCATTER' || mode === 'FOCUS') ? this.posScatter : this.posTree;
                this.mesh.position.lerp(target, 2.5 * dt);

                // ÊúùÂêëÊéßÂà∂
                if (mode === 'FOCUS' && STATE.focusTarget === this.mesh) {
                    this.mesh.lookAt(camera.position);
                } else if (mode === 'SCATTER') {
                    this.mesh.rotation.x += this.spinSpeed.x * dt;
                    this.mesh.rotation.y += this.spinSpeed.y * dt;
                } else {
                    this.mesh.rotation.set(
                        THREE.MathUtils.lerp(this.mesh.rotation.x, 0, dt),
                        this.mesh.rotation.y + 0.5 * dt,
                        THREE.MathUtils.lerp(this.mesh.rotation.z, 0, dt)
                    );
                }

                // Áº©ÊîæÊéßÂà∂
                let s = this.baseScale;
                if ((mode === 'SCATTER' || mode === 'FOCUS') && this.type === 'PHOTO') {
                    s = this.baseScale * CONFIG.photoScale;
                }
                this.mesh.scale.lerp(new THREE.Vector3(s, s, s), 4 * dt);
            }
        }

        // ÂàõÂª∫Á≤íÂ≠êÁ≥ªÁªü (ÂèÇËÄÉdemoË∞ÉÊï¥ÁêÉÁöÑÂ§ßÂ∞èÂíåÂàÜÂ∏É)
        function createParticles() {
            const sphere = new THREE.SphereGeometry(0.5, 32, 32);
            const box = new THREE.BoxGeometry(0.55, 0.55, 0.55);
            const curve = new THREE.CatmullRomCurve3([
                new THREE.Vector3(0, -0.5, 0),
                new THREE.Vector3(0, 0.3, 0),
                new THREE.Vector3(0.1, 0.5, 0),
                new THREE.Vector3(0.3, 0.4, 0)
            ]);
            const candy = new THREE.TubeGeometry(curve, 16, 0.08, 8, false);

            // ÂàõÂª∫Ë£ÖÈ•∞ÁêÉÔºà‰∏ªËâ≤ÁêÉÔºâ- Êõ¥Â§ß„ÄÅÊõ¥Á¥ßÂØÜ
            for (let i = 0; i < CONFIG.ornamentCount; i++) {
                const mesh = new THREE.Mesh(sphere, MATERIALS.gold);
                // ÁêÉÁöÑÂ§ßÂ∞èÔºöÂ∫ïÈÉ®Êõ¥Â§ßÔºåÈ°∂ÈÉ®Êõ¥Â∞èÔºàÂèÇËÄÉdemoÔºâ
                const sizeRange = CONFIG.ballSizeMax - CONFIG.ballSizeMin;
                const s = CONFIG.ballSizeMin + Math.random() * sizeRange;
                mesh.scale.set(s, s, s);
                mesh.rotation.set(Math.random() * 6, Math.random() * 6, Math.random() * 6);
                mainGroup.add(mesh);
                particleSystem.push(new Particle(mesh, 'GOLD_SPHERE'));
            }

            // ÂàõÂª∫ÁôΩËâ≤ÁêÉ/Á¨¨‰∫åËâ≤ÁêÉ - Êõ¥Â§ß
            for (let i = 0; i < CONFIG.whiteBallCount; i++) {
                const mesh = new THREE.Mesh(sphere, MATERIALS.red);
                const sizeRange = CONFIG.ballSizeMax - CONFIG.ballSizeMin;
                const s = CONFIG.ballSizeMin + Math.random() * sizeRange;
                mesh.scale.set(s, s, s);
                mesh.rotation.set(Math.random() * 6, Math.random() * 6, Math.random() * 6);
                mainGroup.add(mesh);
                particleSystem.push(new Particle(mesh, 'RED'));
            }

            // ÂàõÂª∫ÊñπÂùóÔºàÁªøËâ≤ÂíåÈáëËâ≤Ôºâ- ‰ΩøÁî®ÈÖçÁΩÆÁöÑÊï∞Èáè
            for (let i = 0; i < CONFIG.boxCount; i++) {
                const isGold = Math.random() < 0.4;
                const mesh = new THREE.Mesh(box, isGold ? MATERIALS.gold : MATERIALS.green);
                const type = isGold ? 'GOLD_BOX' : 'BOX';
                const s = 0.4 + Math.random() * 0.4;
                mesh.scale.set(s, s, s);
                mesh.rotation.set(Math.random() * 6, Math.random() * 6, Math.random() * 6);
                mainGroup.add(mesh);
                particleSystem.push(new Particle(mesh, type));
            }

            // ÂàõÂª∫Á≥ñÊûúÊ£í - ‰ΩøÁî®ÈÖçÁΩÆÁöÑÊï∞Èáè
            for (let i = 0; i < CONFIG.candyCount; i++) {
                const mesh = new THREE.Mesh(candy, MATERIALS.candy);
                const s = 0.4 + Math.random() * 0.5;
                mesh.scale.set(s, s, s);
                mesh.rotation.set(Math.random() * 6, Math.random() * 6, Math.random() * 6);
                mainGroup.add(mesh);
                particleSystem.push(new Particle(mesh, 'CANE'));
            }

            // È°∂ÈÉ®‰∫îËßíÊòü
            const starShape = new THREE.Shape();
            const outerRadius = 1.2;
            const innerRadius = 0.48;
            const points = 5;

            for (let i = 0; i < points * 2; i++) {
                const angle = (i * Math.PI) / points - Math.PI / 2;
                const radius = i % 2 === 0 ? outerRadius : innerRadius;
                const x = Math.cos(angle) * radius;
                const y = Math.sin(angle) * radius;
                if (i === 0) starShape.moveTo(x, y);
                else starShape.lineTo(x, y);
            }
            starShape.closePath();

            const extrudeSettings = {
                depth: 0.2,
                bevelEnabled: true,
                bevelThickness: 0.1,
                bevelSize: 0.1,
                bevelSegments: 3
            };
            const starGeometry = new THREE.ExtrudeGeometry(starShape, extrudeSettings);
            starGeometry.center();

            const topStar = new THREE.Mesh(starGeometry, MATERIALS.star);
            topStar.position.set(0, 9, 0);  // Ë∞ÉÊï¥Âà∞Ê†ëÈ°∂‰∏äÊñπ
            // ‰∏çÊóãËΩ¨ÔºåËÆ©ÊòüÊòüÊ≠£Èù¢ÊúùÂêëÁõ∏Êú∫ÔºàZËΩ¥ÊñπÂêëÔºâ
            mainGroup.add(topStar);

            // ÊòüÊòüÁÇπÂÖâÊ∫ê
            const starLight = new THREE.PointLight(0xffd700, 2, 10);
            starLight.position.set(0, 9, 0);  // ‰∏éÊòüÊòüÂêåÊ≠•
            mainGroup.add(starLight);

            // ‰øùÂ≠òÂºïÁî®Áî®‰∫éÂä®Áîª
            window.topStar = topStar;
            window.starLight = starLight;

            mainGroup.add(photoMeshGroup);
        }

        // ÂàõÂª∫Èõ™Ëä±
        function createSnow() {
            const snowCount = CONFIG.snowCount * 3; // ÊØè‰∏™Èõ™Ëä±3‰∏™ÂùêÊ†áÂÄº
            const positions = new Float32Array(snowCount);
            for (let i = 0; i < snowCount; i += 3) {
                positions[i] = (Math.random() - 0.5) * 80;
                positions[i + 1] = (Math.random() - 0.5) * 80 + 20;
                positions[i + 2] = (Math.random() - 0.5) * 80;
            }

            snowSystem = new THREE.Points(
                new THREE.BufferGeometry().setAttribute('position', new THREE.BufferAttribute(positions, 3)),
                new THREE.PointsMaterial({
                    color: 0xffffff,
                    size: CONFIG.snowSize,
                    transparent: true,
                    opacity: 0.6,
                    blending: THREE.AdditiveBlending
                })
            );
            scene.add(snowSystem);
        }

        // ÂàõÂª∫ÈªòËÆ§ÁÖßÁâá
        let defaultPhotoTexture;
        function createDefaultPhotos() {
            const canvas = document.createElement('canvas');
            canvas.width = 512;
            canvas.height = 512;
            const ctx = canvas.getContext('2d');

            ctx.fillStyle = '#050505';
            ctx.fillRect(0, 0, 512, 512);
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 15;
            ctx.strokeRect(20, 20, 472, 472);
            ctx.font = '500 60px Times New Roman';
            ctx.fillStyle = '#aaddff';
            ctx.textAlign = 'center';
            ctx.fillText("È¢ÑÁ•ùÂÆ∂‰∫∫‰ª¨", 256, 230);
            ctx.fillText("Âú£ËØûÂø´‰πêÔºÅ", 256, 300);

            defaultPhotoTexture = new THREE.CanvasTexture(canvas);
            defaultPhotoTexture.colorSpace = THREE.SRGBColorSpace;
            addPhotoToScene(defaultPhotoTexture);
        }

        // Ê∑ªÂä†ÁÖßÁâáÂà∞Âú∫ÊôØ
        function addPhotoToScene(texture, base64Data = null, photoId = null) {
            const ar = texture.image.width / texture.image.height;
            const w = ar > 1 ? 1.2 : 1.2 * ar;
            const h = ar > 1 ? 1.2 / ar : 1.2;

            const group = new THREE.Group();
            group.add(new THREE.Mesh(
                new THREE.BoxGeometry(w + 0.1, h + 0.1, 0.05),
                MATERIALS.frame
            ));

            const photoMaterial = new THREE.MeshBasicMaterial({
                map: texture,
                side: THREE.DoubleSide
            });
            const photo = new THREE.Mesh(
                new THREE.PlaneGeometry(w, h),
                photoMaterial
            );
            photo.position.z = 0.04;
            group.add(photo);

            // Ê∑ªÂä†ËÉåÈù¢ÁÖßÁâáÔºåËÆ©‰∏§Èù¢ÈÉΩÊòæÁ§∫ÂõæÁâá
            const photoBack = new THREE.Mesh(
                new THREE.PlaneGeometry(w, h),
                photoMaterial
            );
            photoBack.position.z = -0.04;
            photoBack.rotation.y = Math.PI;
            group.add(photoBack);
            group.scale.setScalar(0.8);

            // Â≠òÂÇ®photoId‰ª•‰æøÂêéÁª≠ÁÆ°ÁêÜ
            if (photoId) {
                group.userData.photoId = photoId;
                photoIdToMeshMap.set(photoId, group);
            }

            photoMeshGroup.add(group);
            particleSystem.push(new Particle(group, 'PHOTO'));

            // ‰øùÂ≠òbase64Êï∞ÊçÆ
            if (base64Data) {
                photoDataArray.push(base64Data);
            }

            return group;
        }

        // ‰ªéÂú∫ÊôØÁßªÈô§ÁÖßÁâá
        function removePhotoFromScene(photoId) {
            const mesh = photoIdToMeshMap.get(photoId);
            if (mesh) {
                // ‰ªéÁ≤íÂ≠êÁ≥ªÁªü‰∏≠ÁßªÈô§
                const particleIndex = particleSystem.findIndex(p => p.mesh === mesh);
                if (particleIndex !== -1) {
                    particleSystem.splice(particleIndex, 1);
                }
                // ‰ªéÂú∫ÊôØ‰∏≠ÁßªÈô§
                photoMeshGroup.remove(mesh);
                // Ê∏ÖÁêÜÊò†Â∞Ñ
                photoIdToMeshMap.delete(photoId);

                // ‰ªéphotoDataArray‰∏≠ÁßªÈô§ÂØπÂ∫îÁöÑbase64Êï∞ÊçÆ
                // ÈúÄË¶ÅÈÄöËøámeshÁöÑuserDataÊàñÂÖ∂‰ªñÊñπÂºèÊâæÂà∞ÂØπÂ∫îÁ¥¢Âºï
                return true;
            }
            return false;
        }

        // ÂêéÂ§ÑÁêÜ
        function setupPostProcessing() {
            composer = new EffectComposer(renderer);
            composer.addPass(new RenderPass(scene, camera));
            bloomPass = new UnrealBloomPass(
                new THREE.Vector2(window.innerWidth, window.innerHeight),
                1.5,
                0.4,
                0.85
            );
            composer.addPass(bloomPass);
        }

        // UIÈöêËóèÁä∂ÊÄÅ
        let uiHidden = false;

        // ÂàáÊç¢ÊâÄÊúâUIÊòæÁ§∫/ÈöêËóè
        function toggleAllUI() {
            uiHidden = !uiHidden;
            const newDisplay = uiHidden ? 'none' : '';

            // Ê†áÈ¢ò
            const h1 = document.querySelector('h1');
            if (h1) h1.style.display = newDisplay;

            // È°∂ÈÉ®ÊåâÈíÆ
            const uploadWrapper = document.querySelector('.upload-wrapper');
            if (uploadWrapper) uploadWrapper.style.display = newDisplay;

            // Êìç‰ΩúÊèêÁ§∫
            const tips = document.getElementById('tips');
            if (tips) tips.style.display = newDisplay;

            // ÁßªÂä®Á´ØÊéßÂà∂ÊåâÈíÆ
            const mobileControls = document.getElementById('mobile-controls');
            if (mobileControls) mobileControls.style.display = uiHidden ? 'none' : 'flex';

            // ÊëÑÂÉèÂ§¥È¢ÑËßà
            const webcamWrapper = document.getElementById('webcam-wrapper');
            if (webcamWrapper) webcamWrapper.style.display = newDisplay;

            // Èü≥‰πêÊí≠ÊîæÂô®Â∞èÈÉ®‰ª∂
            const musicWidget = document.getElementById('music-widget');
            if (musicWidget) musicWidget.style.display = uiHidden ? 'none' : 'flex';
        }

        // ‰∫ã‰ª∂ÁõëÂê¨
        function setupEvents() {
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
                composer.setSize(window.innerWidth, window.innerHeight);
            });

            // Èü≥‰πêÊéßÂà∂ - ÊâìÂºÄÈü≥‰πêÁÆ°ÁêÜÊ®°ÊÄÅÊ°Ü
            const musicBtn = document.getElementById('music-btn');
            musicBtn.addEventListener('click', () => {
                document.getElementById('music-modal').classList.add('show');
            });

            // ÈîÆÁõòÊéßÂà∂ÊòæÁ§∫ÈöêËóè
            document.addEventListener('keydown', (e) => {
                const key = e.key.toLowerCase();

                // VÈîÆ - ÂàáÊç¢ÊëÑÂÉèÂ§¥È¢ÑËßàÂå∫Âüü
                if (key === 'v') {
                    const webcamWrapper = document.getElementById('webcam-wrapper');
                    webcamWrapper.style.display = webcamWrapper.style.display === 'none' ? 'block' : 'none';
                }

                // FÈîÆ - ÂàáÊç¢ÂÖ®Â±è
                if (key === 'f') {
                    if (!document.fullscreenElement) {
                        document.documentElement.requestFullscreen().catch(err => {
                            console.log('ÂÖ®Â±èÂàáÊç¢Â§±Ë¥•:', err);
                        });
                    } else {
                        document.exitFullscreen();
                    }
                }

                // HÈîÆ - ÂàáÊç¢ÊâÄÊúâUIÊéß‰ª∂ÔºàÊ†áÈ¢ò„ÄÅÊåâÈíÆ„ÄÅÊèêÁ§∫„ÄÅÊëÑÂÉèÂ§¥Ôºâ
                if (key === 'h') {
                    toggleAllUI();
                }

                // ÈîÆÁõò‰∫§‰∫í - Êõø‰ª£ÊâãÂäøÊéßÂà∂ÔºàÈÄÇÁî®‰∫éÊ≤°ÊúâÊëÑÂÉèÂ§¥ÁöÑÁîµËÑëÔºâ
                // 1ÈîÆÊàñTÈîÆ - Âú£ËØûÊ†ëÊ®°ÂºèÔºàÂØπÂ∫îÊè°Êã≥ÊâãÂäøÔºâ
                if (key === '1' || key === 't') {
                    STATE.mode = 'TREE';
                    STATE.focusTarget = null;
                }

                // 2ÈîÆÊàñSÈîÆ - ÊòüÊ≤≥Êï£ÂºÄÊ®°ÂºèÔºàÂØπÂ∫îÂº†ÊâãÊâãÂäøÔºâ
                if (key === '2' || key === 's') {
                    STATE.mode = 'SCATTER';
                    STATE.focusTarget = null;
                }

                // 3ÈîÆÊàñPÈîÆ - ÈîÅÂÆöÁÖßÁâáÊ®°ÂºèÔºàÂØπÂ∫îÊçèÂêàÊâãÂäøÔºâ
                if (key === '3' || key === 'p') {
                    STATE.mode = 'FOCUS';
                    // ÈáçÁΩÆÊâÄÊúâÂÅèÁßªÈáèÔºåËÆ©ÁÖßÁâáÂ±Ö‰∏≠
                    STATE.pinch.offsetX = 0;
                    STATE.pinch.offsetY = 0;
                    STATE.pinch.zoom = 1;
                    STATE.handPinch.offsetX = 0;
                    STATE.handPinch.offsetY = 0;
                    if (camera) {
                        camera.fov = 42;
                        camera.updateProjectionMatrix();
                    }
                    if (!STATE.focusTarget) {
                        const photos = particleSystem.filter(p => p.type === 'PHOTO');
                        if (photos.length) {
                            STATE.focusTarget = photos[Math.floor(Math.random() * photos.length)].mesh;
                        }
                    }
                }

                // NÈîÆ - ÂàáÊç¢Âà∞‰∏ã‰∏ÄÂº†ÁÖßÁâáÔºàÂú®FOCUSÊ®°Âºè‰∏ãÔºâ
                if (key === 'n' && STATE.mode === 'FOCUS') {
                    const photos = particleSystem.filter(p => p.type === 'PHOTO');
                    if (photos.length > 1) {
                        const currentIndex = photos.findIndex(p => p.mesh === STATE.focusTarget);
                        const nextIndex = (currentIndex + 1) % photos.length;
                        STATE.focusTarget = photos[nextIndex].mesh;
                    }
                }
            });

            // ========== ÁßªÂä®Á´ØËß¶Êë∏ÊéßÂà∂ ==========
            setupMobileControls();

            // ========== PCÁ´ØÈº†Ê†áÊéßÂà∂ ==========
            setupMouseControls();

            // ========== ÂèåÂáªÈöêËóèUI ==========
            setupDoubleClickHideUI();

            // ÁºìÂ≠òÁÆ°ÁêÜÊ®°ÊÄÅÊ°Ü
            setupCacheManagement();
            // ÂØºÂá∫ÂëΩÂêçÂØπËØùÊ°Ü
            setupExportNameModal();
            // Èü≥‰πêÁÆ°ÁêÜ
            setupMusicManagement();
            // ÈÖçÁΩÆÈù¢Êùø
            setupSettingsPanel();
        }

        // ÁºìÂ≠òÁÆ°ÁêÜÂäüËÉΩ
        function setupCacheManagement() {
            const modal = document.getElementById('cache-modal');
            const manageBtn = document.getElementById('manage-btn');
            const closeBtn = document.getElementById('modal-close');
            const clearAllBtn = document.getElementById('clear-all-btn');
            const photoGrid = document.getElementById('photo-grid');
            const cacheStats = document.getElementById('cache-stats');

            // ÊâìÂºÄÊ®°ÊÄÅÊ°Ü
            manageBtn.addEventListener('click', () => {
                modal.classList.add('show');
                renderPhotoGrid();
            });

            // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
            closeBtn.addEventListener('click', () => {
                modal.classList.remove('show');
            });

            // ÁÇπÂáªËÉåÊôØÂÖ≥Èó≠
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('show');
                }
            });

            // Ê∏ÖÁ©∫ÂÖ®ÈÉ®ÁºìÂ≠ò
            clearAllBtn.addEventListener('click', async () => {
                if (!confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÁºìÂ≠òÁöÑÁÖßÁâáÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§çÔºÅ')) return;

                // ‰ªéÂú∫ÊôØ‰∏≠ÁßªÈô§ÊâÄÊúâÁÖßÁâá
                const photos = await PhotoCache.getAllPhotos();
                photos.forEach(photo => {
                    removePhotoFromScene(photo.id);
                });

                // Ê∏ÖÁ©∫ÁºìÂ≠ò
                await PhotoCache.clearAll();
                photoDataArray = [];

                renderPhotoGrid();
                alert('Â∑≤Ê∏ÖÁ©∫ÊâÄÊúâÁºìÂ≠òÁÖßÁâáÔºÅ');
            });

            // ‰∏ä‰º†ÁÖßÁâá
            document.getElementById('file-input').addEventListener('change', async (e) => {
                const files = Array.from(e.target.files);
                let uploadedCount = 0;

                for (const file of files) {
                    const reader = new FileReader();
                    reader.onload = async (ev) => {
                        const base64 = ev.target.result;

                        // ÂÖà‰øùÂ≠òÂà∞ÁºìÂ≠ò
                        const result = await PhotoCache.savePhoto(base64);
                        if (!result.success) {
                            alert(result.message);
                            return;
                        }

                        // Âä†ËΩΩÁ∫πÁêÜÂπ∂Ê∑ªÂä†Âà∞Âú∫ÊôØ
                        new THREE.TextureLoader().load(base64, (texture) => {
                            texture.colorSpace = THREE.SRGBColorSpace;
                            addPhotoToScene(texture, base64, result.photo.id);
                            uploadedCount++;

                            // ‰∏ä‰º†ÂÆåÊàêÂêéÂà∑Êñ∞ÁΩëÊ†º
                            if (uploadedCount === files.length) {
                                renderPhotoGrid();
                            }
                        });
                    };
                    reader.readAsDataURL(file);
                }
                e.target.value = ''; // Ê∏ÖÁ©∫inputÔºåÂÖÅËÆ∏ÈáçÂ§ç‰∏ä‰º†
            });

            // ÂØºÂÖ•ÁÖßÁâá
            document.getElementById('import-input').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (ev) => {
                    try {
                        const importData = JSON.parse(ev.target.result);

                        if (!importData.photos || !Array.isArray(importData.photos)) {
                            alert('Êó†ÊïàÁöÑÁÖßÁâáÊï∞ÊçÆÊ†ºÂºèÔºÅ');
                            return;
                        }

                        let loadedCount = 0;
                        let failedCount = 0;

                        for (const base64 of importData.photos) {
                            // ÂÖà‰øùÂ≠òÂà∞ÁºìÂ≠ò
                            const result = await PhotoCache.savePhoto(base64);
                            if (!result.success) {
                                failedCount++;
                                if (failedCount === 1) {
                                    alert(result.message);
                                }
                                continue;
                            }

                            await new Promise((resolve) => {
                                new THREE.TextureLoader().load(base64, (texture) => {
                                    texture.colorSpace = THREE.SRGBColorSpace;
                                    addPhotoToScene(texture, base64, result.photo.id);
                                    loadedCount++;
                                    resolve();
                                });
                            });
                        }

                        renderPhotoGrid();

                        if (loadedCount > 0) {
                            alert(`ÊàêÂäüÂØºÂÖ• ${loadedCount} Âº†ÁÖßÁâáÔºÅ${failedCount > 0 ? `\n${failedCount} Âº†Âõ†ÁºìÂ≠òÈôêÂà∂Êú™ËÉΩÂØºÂÖ•` : ''}`);
                        }
                    } catch (error) {
                        console.error('ÂØºÂÖ•Â§±Ë¥•:', error);
                        alert('ÂØºÂÖ•Â§±Ë¥•ÔºÅËØ∑Á°Æ‰øùÊñá‰ª∂Ê†ºÂºèÊ≠£Á°Æ„ÄÇ');
                    }
                };
                reader.readAsText(file);
                e.target.value = ''; // Ê∏ÖÁ©∫inputÔºåÂÖÅËÆ∏ÈáçÂ§çÂØºÂÖ•Âêå‰∏ÄÊñá‰ª∂
            });

            // ÂØºÂá∫ÁÖßÁâá - ÊòæÁ§∫ÂëΩÂêçÂØπËØùÊ°Ü
            document.getElementById('export-btn').addEventListener('click', async () => {
                const photos = await PhotoCache.getAllPhotos();
                if (photos.length === 0) {
                    alert('Ê≤°ÊúâÂèØÂØºÂá∫ÁöÑÁÖßÁâáÔºÅËØ∑ÂÖà‰∏ä‰º†ÁÖßÁâá„ÄÇ');
                    return;
                }

                // ÊòæÁ§∫ÂëΩÂêçÂØπËØùÊ°Ü
                showExportNameModal();
            });

            // Ê∏≤ÊüìÁÖßÁâáÁΩëÊ†º
            async function renderPhotoGrid() {
                const photos = await PhotoCache.getAllPhotos();
                const stats = await PhotoCache.getStats();

                // Êõ¥Êñ∞ÁªüËÆ°‰ø°ÊÅØ
                const isWarning = stats.count >= CACHE_CONFIG.maxPhotos * 0.8 ||
                    stats.totalSize / (1024 * 1024) >= CACHE_CONFIG.maxSizeMB * 0.8;

                cacheStats.innerHTML = `Â∑≤ÁºìÂ≠ò <span class="${isWarning ? 'warning' : 'highlight'}">${stats.count}</span> Âº†ÁÖßÁâá ` +
                    `(<span class="${isWarning ? 'warning' : 'highlight'}">${PhotoCache.formatSize(stats.totalSize)}</span> / ${CACHE_CONFIG.maxSizeMB} MB)`;

                // Ê∏≤ÊüìÁÖßÁâáÂàóË°®
                if (photos.length === 0) {
                    photoGrid.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üì∑</div>
                            <div>ÊöÇÊó†ÁºìÂ≠òÁÖßÁâá</div>
                            <div style="margin-top:10px; font-size:9px;">‰∏ä‰º†ÁÖßÁâáÂêé‰ºöËá™Âä®ÁºìÂ≠òÂà∞Êú¨Âú∞</div>
                        </div>
                    `;
                    return;
                }

                photoGrid.innerHTML = photos.map(photo => {
                    const isInScene = photoIdToMeshMap.has(photo.id);
                    return `
                        <div class="photo-item ${isInScene ? 'in-scene' : ''}" data-id="${photo.id}">
                            <img class="photo-thumb" src="${photo.base64}" alt="ÁÖßÁâá">
                            <div class="photo-info">
                                <div class="photo-size">${PhotoCache.formatSize(photo.size)}</div>
                                <div class="photo-status">${isInScene ? '‚úì Â∑≤Ê∑ªÂä†Âà∞Âú∫ÊôØ' : 'Êú™Ê∑ªÂä†'}</div>
                                <div class="photo-actions">
                                    ${isInScene ?
                            `<button class="photo-action-btn remove-scene" data-action="remove" data-id="${photo.id}">‰ªéÂú∫ÊôØÁßªÈô§</button>` :
                            `<button class="photo-action-btn add-scene" data-action="add" data-id="${photo.id}">Ê∑ªÂä†Âà∞Âú∫ÊôØ</button>`
                        }
                                    <button class="photo-action-btn delete" data-action="delete" data-id="${photo.id}">Âà†Èô§</button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                // ÁªëÂÆöÊåâÈíÆ‰∫ã‰ª∂
                photoGrid.querySelectorAll('.photo-action-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const action = e.target.dataset.action;
                        const photoId = e.target.dataset.id;

                        if (action === 'add') {
                            await addPhotoToSceneFromCache(photoId);
                        } else if (action === 'remove') {
                            await removePhotoAndUpdateCache(photoId);
                        } else if (action === 'delete') {
                            await deletePhotoFromCache(photoId);
                        }

                        renderPhotoGrid();
                    });
                });
            }

            // ‰ªéÁºìÂ≠òÊ∑ªÂä†ÁÖßÁâáÂà∞Âú∫ÊôØ
            async function addPhotoToSceneFromCache(photoId) {
                const photos = await PhotoCache.getAllPhotos();
                const photo = photos.find(p => p.id === photoId);
                if (!photo) return;

                await new Promise((resolve) => {
                    new THREE.TextureLoader().load(photo.base64, (texture) => {
                        texture.colorSpace = THREE.SRGBColorSpace;
                        addPhotoToScene(texture, photo.base64, photo.id);
                        resolve();
                    });
                });

                // Êõ¥Êñ∞ÁºìÂ≠ò‰∏≠ÁöÑÁä∂ÊÄÅ
                photo.inScene = true;
                await PhotoCache.updatePhoto(photo);
            }

            // ‰ªéÂú∫ÊôØÁßªÈô§ÁÖßÁâáÂπ∂Êõ¥Êñ∞ÁºìÂ≠ò
            async function removePhotoAndUpdateCache(photoId) {
                removePhotoFromScene(photoId);

                // Êõ¥Êñ∞ÁºìÂ≠ò‰∏≠ÁöÑÁä∂ÊÄÅ
                const photos = await PhotoCache.getAllPhotos();
                const photo = photos.find(p => p.id === photoId);
                if (photo) {
                    photo.inScene = false;
                    await PhotoCache.updatePhoto(photo);
                }
            }

            // ‰ªéÁºìÂ≠ò‰∏≠Âà†Èô§ÁÖßÁâá
            async function deletePhotoFromCache(photoId) {
                if (!confirm('Á°ÆÂÆöË¶Å‰ªéÁºìÂ≠ò‰∏≠Âà†Èô§ËøôÂº†ÁÖßÁâáÂêóÔºü')) return;

                // Â¶ÇÊûúÂú®Âú∫ÊôØ‰∏≠ÔºåÂÖàÁßªÈô§
                removePhotoFromScene(photoId);

                // ‰ªéÁºìÂ≠ò‰∏≠Âà†Èô§
                await PhotoCache.deletePhoto(photoId);
            }
        }

        // ÊòæÁ§∫ÂØºÂá∫ÂëΩÂêçÂØπËØùÊ°Ü
        function showExportNameModal() {
            const modal = document.getElementById('export-name-modal');
            const themeInput = document.getElementById('export-theme');
            const customInput = document.getElementById('export-custom');
            const dateInput = document.getElementById('export-date');
            const previewSpan = document.getElementById('filename-preview');

            // ËÆæÁΩÆÈªòËÆ§ÂÄº
            themeInput.value = 'Merry Christmas';
            customInput.value = '';
            dateInput.value = new Date().toISOString().split('T')[0]; // 2024-12-14Ê†ºÂºè

            // Êõ¥Êñ∞È¢ÑËßà
            function updatePreview() {
                const theme = themeInput.value.trim() || 'Merry Christmas';
                const custom = customInput.value.trim();
                const date = dateInput.value;

                let filename = '';
                if (custom) {
                    filename = custom + '_';
                }
                filename += theme + '_' + date + '.json';

                previewSpan.textContent = filename;
            }

            updatePreview();

            // ÁßªÈô§ÊóßÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®ÔºàÈò≤Ê≠¢ÈáçÂ§çÁªëÂÆöÔºâ
            const newThemeInput = themeInput.cloneNode(true);
            const newCustomInput = customInput.cloneNode(true);
            themeInput.parentNode.replaceChild(newThemeInput, themeInput);
            customInput.parentNode.replaceChild(newCustomInput, customInput);

            // ÈáçÊñ∞Ëé∑ÂèñÂÖÉÁ¥†Âπ∂ÁªëÂÆö‰∫ã‰ª∂
            document.getElementById('export-theme').addEventListener('input', updatePreview);
            document.getElementById('export-custom').addEventListener('input', updatePreview);

            modal.classList.add('show');
        }

        // ËÆæÁΩÆÂØºÂá∫ÂëΩÂêçÂØπËØùÊ°Ü‰∫ã‰ª∂
        function setupExportNameModal() {
            const modal = document.getElementById('export-name-modal');
            const closeBtn = document.getElementById('export-name-close');
            const cancelBtn = document.getElementById('export-cancel');
            const confirmBtn = document.getElementById('export-confirm');

            // ÂÖ≥Èó≠ÂØπËØùÊ°Ü
            closeBtn.addEventListener('click', () => modal.classList.remove('show'));
            cancelBtn.addEventListener('click', () => modal.classList.remove('show'));
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.classList.remove('show');
            });

            // Á°ÆËÆ§ÂØºÂá∫
            confirmBtn.addEventListener('click', async () => {
                const theme = document.getElementById('export-theme').value.trim() || 'Merry Christmas';
                const custom = document.getElementById('export-custom').value.trim();
                const date = document.getElementById('export-date').value;

                // ÁîüÊàêÊñá‰ª∂Âêç
                let filename = '';
                if (custom) {
                    filename = custom + '_';
                }
                filename += theme + '_' + date + '.json';

                // ÊâßË°åÂØºÂá∫
                const photos = await PhotoCache.getAllPhotos();
                const exportData = {
                    version: '1.0',
                    exportDate: new Date().toISOString(),
                    photos: photos.map(p => p.base64)
                };

                const dataStr = JSON.stringify(exportData, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);

                modal.classList.remove('show');
                alert(`ÊàêÂäüÂØºÂá∫ ${photos.length} Âº†ÁÖßÁâáÔºÅ\nÊñá‰ª∂Âêç: ${filename}`);
            });
        }

        // ========== ‰∏ªÈ¢òÂàáÊç¢ÂáΩÊï∞ ==========
        // ËæÖÂä©ÂáΩÊï∞ÔºöÂ∞ÜÂçÅÂÖ≠ËøõÂà∂È¢úËâ≤ËΩ¨Êç¢‰∏∫RGBÂÄº
        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` : '0, 255, 204';
        }

        // ËæÖÂä©ÂáΩÊï∞Ôºö‰ΩøÈ¢úËâ≤Âèò‰∫Æ
        function lightenColor(hex, percent) {
            const num = parseInt(hex.replace('#', ''), 16);
            const amt = Math.round(2.55 * percent);
            const R = Math.min(255, (num >> 16) + amt);
            const G = Math.min(255, ((num >> 8) & 0x00FF) + amt);
            const B = Math.min(255, (num & 0x0000FF) + amt);
            return `#${(0x1000000 + R * 0x10000 + G * 0x100 + B).toString(16).slice(1)}`;
        }

        function applyTheme(themeName) {
            const theme = THEMES[themeName];
            if (!theme) return;

            currentTheme = themeName;

            // Êõ¥Êñ∞CONFIG‰∏≠ÁöÑÈ¢úËâ≤ÈÖçÁΩÆ
            CONFIG.ornamentColor = theme.ornamentColor;
            CONFIG.whiteBallColor = theme.whiteBallColor;
            CONFIG.boxColor = theme.boxColor;
            CONFIG.lightColor = theme.lightColor;
            CONFIG.starColor = theme.starColor;
            CONFIG.snowColor = theme.snowColor;

            // Ê†πÊçÆHDRÂä†ËΩΩÁä∂ÊÄÅÈÄâÊã©Ê≥õÂÖâÂèÇÊï∞
            if (hdrLoaded) {
                // HDRÂä†ËΩΩÊàêÂäüÔºå‰ΩøÁî®‰ΩéÊ≥õÂÖâÂèÇÊï∞
                CONFIG.bloomStrength = theme.bloomStrengthHDR;
                CONFIG.bloomRadius = theme.bloomRadiusHDR;
                console.log(`Â∫îÁî®‰∏ªÈ¢ò ${theme.name} (HDRÊ®°Âºè): Ê≥õÂÖâÂº∫Â∫¶=${CONFIG.bloomStrength}, ÂçäÂæÑ=${CONFIG.bloomRadius}`);
            } else {
                // HDRÂä†ËΩΩÂ§±Ë¥•Ôºå‰ΩøÁî®ÈªòËÆ§Ê≥õÂÖâÂèÇÊï∞
                CONFIG.bloomStrength = theme.bloomStrength;
                CONFIG.bloomRadius = theme.bloomRadius;
                console.log(`Â∫îÁî®‰∏ªÈ¢ò ${theme.name} (ÈªòËÆ§Ê®°Âºè): Ê≥õÂÖâÂº∫Â∫¶=${CONFIG.bloomStrength}, ÂçäÂæÑ=${CONFIG.bloomRadius}`);
            }

            // Â∫îÁî®È¢úËâ≤Âà∞Âú∫ÊôØ
            applyColorSettings();

            // Êõ¥Êñ∞ËÉåÊôØÊ∏êÂèò
            document.body.style.background = `radial-gradient(circle at center, ${theme.bgGradient[0]} 0%, ${theme.bgGradient[1]} 100%)`;

            // Êõ¥Êñ∞Ê†áÈ¢òÊ∏êÂèò
            const h1 = document.querySelector('h1');
            if (h1) {
                h1.style.background = `linear-gradient(135deg, ${theme.titleGradient[0]} 0%, ${theme.titleGradient[1]} 50%, ${theme.titleGradient[2]} 100%)`;
                h1.style.backgroundSize = '200% auto';
                h1.style.webkitBackgroundClip = 'text';
                h1.style.backgroundClip = 'text';
                h1.style.webkitTextFillColor = 'transparent';
            }

            // Êõ¥Êñ∞UIÂº∫Ë∞ÉËâ≤ÔºàCSSÂèòÈáèÊñπÂºèÔºâ
            document.documentElement.style.setProperty('--accent-color', theme.accentColor);
            document.documentElement.style.setProperty('--accent-color-rgb', hexToRgb(theme.accentColor));
            document.documentElement.style.setProperty('--accent-color-light', lightenColor(theme.accentColor, 30));

            // Êõ¥Êñ∞È¢úËâ≤ÈÄâÊã©Âô®ÁöÑÂÄº
            document.getElementById('cfg-ornament-color').value = theme.ornamentColor;
            document.getElementById('cfg-whiteball-color').value = theme.whiteBallColor;
            document.getElementById('cfg-box-color').value = theme.boxColor;
            document.getElementById('cfg-light-color').value = theme.lightColor;
            document.getElementById('cfg-star-color').value = theme.starColor;
            document.getElementById('cfg-snow-color').value = theme.snowColor;

            // Êõ¥Êñ∞Ê≥õÂÖâÊªëÂùóÁöÑÂÄº
            document.getElementById('cfg-bloom-strength').value = theme.bloomStrength * 10;
            document.getElementById('cfg-bloom-strength-val').textContent = theme.bloomStrength.toFixed(1);
            document.getElementById('cfg-bloom-radius').value = theme.bloomRadius * 10;
            document.getElementById('cfg-bloom-radius-val').textContent = theme.bloomRadius.toFixed(1);

            // Êõ¥Êñ∞‰∏ªÈ¢òÊåâÈíÆÁä∂ÊÄÅ
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.theme === themeName);
            });

            // ‰øùÂ≠ò‰∏ªÈ¢òÈÄâÊã©
            localStorage.setItem('christmasTheme', themeName);
        }

        // ========== ÈÖçÁΩÆÈù¢Êùø ==========
        function setupSettingsPanel() {
            const modal = document.getElementById('settings-modal');
            const settingsBtn = document.getElementById('settings-btn');
            const closeBtn = document.getElementById('settings-close');
            const resetBtn = document.getElementById('settings-reset');
            const applyBtn = document.getElementById('settings-apply');

            // ‰∏ªÈ¢òÊåâÈíÆ‰∫ã‰ª∂
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const themeName = btn.dataset.theme;
                    applyTheme(themeName);
                });
            });

            // ÊÅ¢Â§ç‰øùÂ≠òÁöÑ‰∏ªÈ¢ò
            const savedTheme = localStorage.getItem('christmasTheme');
            if (savedTheme && THEMES[savedTheme]) {
                applyTheme(savedTheme);
            }

            // ÊâìÂºÄÈù¢Êùø
            settingsBtn.addEventListener('click', () => {
                modal.classList.add('show');
                loadSettingsToUI();
            });

            // ÂÖ≥Èó≠Èù¢Êùø
            closeBtn.addEventListener('click', () => modal.classList.remove('show'));
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.classList.remove('show');
            });

            // ÊªëÂùóÂÆûÊó∂Êõ¥Êñ∞ÊòæÁ§∫ÂÄº
            const sliders = {
                'cfg-tree-distance': { config: 'treeDistance', display: v => v },
                'cfg-scatter-distance': { config: 'scatterDistance', display: v => v },
                'cfg-focus-distance': { config: 'focusDistance', display: v => v },
                'cfg-tree-rotate': { config: 'treeRotate', display: v => (v / 100).toFixed(2) },
                'cfg-scatter-rotate': { config: 'scatterRotate', display: v => (v / 100).toFixed(2) },
                'cfg-bloom-strength': { config: 'bloomStrength', display: v => (v / 10).toFixed(1) },
                'cfg-bloom-radius': { config: 'bloomRadius', display: v => (v / 10).toFixed(1) },
                'cfg-star-glow': { config: 'starGlow', display: v => (v / 10).toFixed(1) },
                'cfg-star-blink': { config: 'starBlink', display: v => (v / 10).toFixed(1) },
                'cfg-snow-speed': { config: 'snowSpeed', display: v => (v / 100).toFixed(2) },
                'cfg-snow-size': { config: 'snowSize', display: v => (v / 10).toFixed(1) },
                'cfg-snow-count': { config: 'snowCount', display: v => v },
                'cfg-ornament-count': { config: 'ornamentCount', display: v => v },
                'cfg-whiteball-count': { config: 'whiteBallCount', display: v => v },
                'cfg-box-count': { config: 'boxCount', display: v => v },
                'cfg-photo-scale': { config: 'photoScale', display: v => (v / 10).toFixed(1) }
            };

            Object.keys(sliders).forEach(id => {
                const slider = document.getElementById(id);
                const valSpan = document.getElementById(id + '-val');
                const cfg = sliders[id];

                slider.addEventListener('input', () => {
                    valSpan.textContent = cfg.display(slider.value);
                });
            });

            // Â∫îÁî®ËÆæÁΩÆ
            applyBtn.addEventListener('click', () => {
                CONFIG.treeDistance = parseInt(document.getElementById('cfg-tree-distance').value);
                CONFIG.scatterDistance = parseInt(document.getElementById('cfg-scatter-distance').value);
                CONFIG.focusDistance = parseInt(document.getElementById('cfg-focus-distance').value);
                CONFIG.treeRotate = parseInt(document.getElementById('cfg-tree-rotate').value) / 100;
                CONFIG.scatterRotate = parseInt(document.getElementById('cfg-scatter-rotate').value) / 100;
                CONFIG.bloomStrength = parseInt(document.getElementById('cfg-bloom-strength').value) / 10;
                CONFIG.bloomRadius = parseInt(document.getElementById('cfg-bloom-radius').value) / 10;
                CONFIG.starGlow = parseInt(document.getElementById('cfg-star-glow').value) / 10;
                CONFIG.starBlink = parseInt(document.getElementById('cfg-star-blink').value) / 10;
                CONFIG.snowSpeed = parseInt(document.getElementById('cfg-snow-speed').value) / 100;
                CONFIG.snowSize = parseInt(document.getElementById('cfg-snow-size').value) / 10;
                CONFIG.snowCount = parseInt(document.getElementById('cfg-snow-count').value);
                CONFIG.ornamentCount = parseInt(document.getElementById('cfg-ornament-count').value);
                CONFIG.whiteBallCount = parseInt(document.getElementById('cfg-whiteball-count').value);
                CONFIG.boxCount = parseInt(document.getElementById('cfg-box-count').value);
                CONFIG.photoScale = parseInt(document.getElementById('cfg-photo-scale').value) / 10;

                // Ëé∑ÂèñÈ¢úËâ≤ÈÖçÁΩÆ
                CONFIG.ornamentColor = document.getElementById('cfg-ornament-color').value;
                CONFIG.whiteBallColor = document.getElementById('cfg-whiteball-color').value;
                CONFIG.boxColor = document.getElementById('cfg-box-color').value;
                CONFIG.lightColor = document.getElementById('cfg-light-color').value;
                CONFIG.starColor = document.getElementById('cfg-star-color').value;
                CONFIG.snowColor = document.getElementById('cfg-snow-color').value;

                // Â∫îÁî®ÊâÄÊúâÈ¢úËâ≤ÂíåÊïàÊûúËÆæÁΩÆ
                applyColorSettings();

                modal.classList.remove('show');
            });

            // ÊÅ¢Â§çÈªòËÆ§
            resetBtn.addEventListener('click', () => {
                CONFIG.treeDistance = 45;
                CONFIG.scatterDistance = 55;
                CONFIG.focusDistance = 8;
                CONFIG.treeRotate = 0.3;
                CONFIG.scatterRotate = 0.1;
                CONFIG.bloomStrength = 0.9;
                CONFIG.bloomRadius = 0.5;
                CONFIG.starGlow = 3;
                CONFIG.starBlink = 1;
                CONFIG.snowSpeed = 0.03;
                CONFIG.snowSize = 0.2;
                CONFIG.snowCount = 1000;
                CONFIG.ornamentCount = 400;
                CONFIG.whiteBallCount = 150;
                CONFIG.boxCount = 100;
                CONFIG.photoScale = 2.5;
                // ÊÅ¢Â§çÂà∞ÂÜ∞Èõ™Â•áÁºò‰∏ªÈ¢ò
                applyTheme('frozen');
                loadSettingsToUI();
            });
        }

        // Â∫îÁî®È¢úËâ≤ËÆæÁΩÆÂà∞Âú∫ÊôØ
        function applyColorSettings() {
            // Â∫îÁî®Èõ™Ëä±È¢úËâ≤
            if (snowSystem && snowSystem.material) {
                snowSystem.material.size = CONFIG.snowSize;
                snowSystem.material.color.set(CONFIG.snowColor);
                snowSystem.material.needsUpdate = true;
            }
            // Â∫îÁî®Ë£ÖÈ•∞ÁêÉÈ¢úËâ≤
            if (MATERIALS.gold) {
                const ornamentHex = parseInt(CONFIG.ornamentColor.replace('#', ''), 16);
                MATERIALS.gold.color.setHex(ornamentHex);
                const emissiveColor = new THREE.Color(ornamentHex).multiplyScalar(0.3);
                MATERIALS.gold.emissive.copy(emissiveColor);
                MATERIALS.gold.emissiveIntensity = 0.5;
                MATERIALS.gold.needsUpdate = true;
            }
            // Â∫îÁî®ÁôΩËâ≤ÁêÉÈ¢úËâ≤
            if (MATERIALS.red) {
                const whiteBallHex = parseInt(CONFIG.whiteBallColor.replace('#', ''), 16);
                MATERIALS.red.color.setHex(whiteBallHex);
                MATERIALS.red.needsUpdate = true;
            }
            // Â∫îÁî®ÊñπÂùóÈ¢úËâ≤
            if (MATERIALS.green) {
                const boxHex = parseInt(CONFIG.boxColor.replace('#', ''), 16);
                MATERIALS.green.color.setHex(boxHex);
                const boxEmissive = new THREE.Color(boxHex).multiplyScalar(0.1);
                MATERIALS.green.emissive.copy(boxEmissive);
                MATERIALS.green.needsUpdate = true;
            }
            // Â∫îÁî®ÊòüÊòüÈ¢úËâ≤
            if (MATERIALS.star) {
                const starHex = parseInt(CONFIG.starColor.replace('#', ''), 16);
                MATERIALS.star.color.setHex(starHex);
                MATERIALS.star.emissive.setHex(starHex);
                MATERIALS.star.needsUpdate = true;
            }
            // Â∫îÁî®ÁÅØÂÖâÈ¢úËâ≤
            if (innerLight) {
                const lightHex = parseInt(CONFIG.lightColor.replace('#', ''), 16);
                innerLight.color.setHex(lightHex);
            }
            // Â∫îÁî®Ê≥õÂÖâËÆæÁΩÆ
            if (bloomPass) {
                bloomPass.radius = CONFIG.bloomRadius;
            }
        }

        function loadSettingsToUI() {
            document.getElementById('cfg-tree-distance').value = CONFIG.treeDistance;
            document.getElementById('cfg-tree-distance-val').textContent = CONFIG.treeDistance;
            document.getElementById('cfg-scatter-distance').value = CONFIG.scatterDistance;
            document.getElementById('cfg-scatter-distance-val').textContent = CONFIG.scatterDistance;
            document.getElementById('cfg-focus-distance').value = CONFIG.focusDistance;
            document.getElementById('cfg-focus-distance-val').textContent = CONFIG.focusDistance;
            document.getElementById('cfg-tree-rotate').value = CONFIG.treeRotate * 100;
            document.getElementById('cfg-tree-rotate-val').textContent = CONFIG.treeRotate.toFixed(2);
            document.getElementById('cfg-scatter-rotate').value = CONFIG.scatterRotate * 100;
            document.getElementById('cfg-scatter-rotate-val').textContent = CONFIG.scatterRotate.toFixed(2);
            document.getElementById('cfg-bloom-strength').value = CONFIG.bloomStrength * 10;
            document.getElementById('cfg-bloom-strength-val').textContent = CONFIG.bloomStrength.toFixed(1);
            document.getElementById('cfg-bloom-radius').value = CONFIG.bloomRadius * 10;
            document.getElementById('cfg-bloom-radius-val').textContent = CONFIG.bloomRadius.toFixed(1);
            document.getElementById('cfg-star-glow').value = CONFIG.starGlow * 10;
            document.getElementById('cfg-star-glow-val').textContent = CONFIG.starGlow.toFixed(1);
            document.getElementById('cfg-star-blink').value = CONFIG.starBlink * 10;
            document.getElementById('cfg-star-blink-val').textContent = CONFIG.starBlink.toFixed(1);
            document.getElementById('cfg-snow-speed').value = CONFIG.snowSpeed * 100;
            document.getElementById('cfg-snow-speed-val').textContent = CONFIG.snowSpeed.toFixed(2);
            document.getElementById('cfg-snow-size').value = CONFIG.snowSize * 10;
            document.getElementById('cfg-snow-size-val').textContent = CONFIG.snowSize.toFixed(1);
            document.getElementById('cfg-photo-scale').value = CONFIG.photoScale * 10;
            document.getElementById('cfg-photo-scale-val').textContent = CONFIG.photoScale.toFixed(1);
            document.getElementById('cfg-snow-count').value = CONFIG.snowCount;
            document.getElementById('cfg-snow-count-val').textContent = CONFIG.snowCount;
            document.getElementById('cfg-ornament-count').value = CONFIG.ornamentCount;
            document.getElementById('cfg-ornament-count-val').textContent = CONFIG.ornamentCount;
            document.getElementById('cfg-whiteball-count').value = CONFIG.whiteBallCount;
            document.getElementById('cfg-whiteball-count-val').textContent = CONFIG.whiteBallCount;
            document.getElementById('cfg-box-count').value = CONFIG.boxCount;
            document.getElementById('cfg-box-count-val').textContent = CONFIG.boxCount;
            // Âä†ËΩΩÈ¢úËâ≤ÈÖçÁΩÆ
            document.getElementById('cfg-ornament-color').value = CONFIG.ornamentColor;
            document.getElementById('cfg-whiteball-color').value = CONFIG.whiteBallColor;
            document.getElementById('cfg-box-color').value = CONFIG.boxColor;
            document.getElementById('cfg-light-color').value = CONFIG.lightColor;
            document.getElementById('cfg-star-color').value = CONFIG.starColor;
            document.getElementById('cfg-snow-color').value = CONFIG.snowColor;
        }

        // ========== ÁßªÂä®Á´ØËß¶Êë∏ÊéßÂà∂ ==========
        function setupMobileControls() {
            const mobileTree = document.getElementById('mobile-tree');
            const mobileScatter = document.getElementById('mobile-scatter');
            const mobilePhoto = document.getElementById('mobile-photo');
            const mobileNext = document.getElementById('mobile-next');

            // Êõ¥Êñ∞ÊåâÈíÆÊøÄÊ¥ªÁä∂ÊÄÅ
            function updateMobileButtonState() {
                mobileTree.classList.toggle('active', STATE.mode === 'TREE');
                mobileScatter.classList.toggle('active', STATE.mode === 'SCATTER');
                mobilePhoto.classList.toggle('active', STATE.mode === 'FOCUS');
            }

            // Âú£ËØûÊ†ëÊ®°Âºè
            mobileTree.addEventListener('click', () => {
                STATE.mode = 'TREE';
                STATE.focusTarget = null;
                updateMobileButtonState();
            });

            // ÊòüÊ≤≥Êï£ÂºÄÊ®°Âºè
            mobileScatter.addEventListener('click', () => {
                STATE.mode = 'SCATTER';
                STATE.focusTarget = null;
                updateMobileButtonState();
            });

            // ÈîÅÂÆöÁÖßÁâáÊ®°Âºè
            mobilePhoto.addEventListener('click', () => {
                STATE.mode = 'FOCUS';
                // ÈáçÁΩÆÊâÄÊúâÂÅèÁßªÈáèÔºåËÆ©ÁÖßÁâáÂ±Ö‰∏≠
                STATE.pinch.offsetX = 0;
                STATE.pinch.offsetY = 0;
                STATE.pinch.zoom = 1;
                STATE.handPinch.offsetX = 0;
                STATE.handPinch.offsetY = 0;
                // ÈáçÁΩÆÁõ∏Êú∫FOV
                if (camera) {
                    camera.fov = 42;
                    camera.updateProjectionMatrix();
                }
                if (!STATE.focusTarget) {
                    const photos = particleSystem.filter(p => p.type === 'PHOTO');
                    if (photos.length) {
                        STATE.focusTarget = photos[Math.floor(Math.random() * photos.length)].mesh;
                    }
                }
                updateMobileButtonState();
            });

            // ‰∏ã‰∏ÄÂº†ÁÖßÁâá
            mobileNext.addEventListener('click', () => {
                const photos = particleSystem.filter(p => p.type === 'PHOTO');
                if (photos.length > 0) {
                    // Â¶ÇÊûú‰∏çÂú®FOCUSÊ®°ÂºèÔºåÂÖàÂàáÊç¢Âà∞FOCUSÊ®°Âºè
                    if (STATE.mode !== 'FOCUS') {
                        STATE.mode = 'FOCUS';
                        // ÈáçÁΩÆÊâÄÊúâÂÅèÁßªÈáè
                        STATE.pinch.offsetX = 0;
                        STATE.pinch.offsetY = 0;
                        STATE.pinch.zoom = 1;
                        STATE.handPinch.offsetX = 0;
                        STATE.handPinch.offsetY = 0;
                        if (camera) {
                            camera.fov = 42;
                            camera.updateProjectionMatrix();
                        }
                    }
                    if (photos.length > 1 && STATE.focusTarget) {
                        const currentIndex = photos.findIndex(p => p.mesh === STATE.focusTarget);
                        const nextIndex = (currentIndex + 1) % photos.length;
                        STATE.focusTarget = photos[nextIndex].mesh;
                    } else if (!STATE.focusTarget) {
                        STATE.focusTarget = photos[0].mesh;
                    }
                    updateMobileButtonState();
                }
            });

            // Ëß¶Êë∏ÊªëÂä®ÊéßÂà∂
            let touchStartX = 0;
            let touchStartY = 0;
            const canvas = document.getElementById('canvas-container');
            const FOCUS_PAN_SENSITIVITY = 0.015; // FOCUSÊ®°Âºè‰∏ãÂπ≥ÁßªÁÅµÊïèÂ∫¶

            canvas.addEventListener('touchstart', (e) => {
                if (e.touches.length === 1) {
                    touchStartX = e.touches[0].clientX;
                    touchStartY = e.touches[0].clientY;
                }
            }, { passive: true });

            canvas.addEventListener('touchmove', (e) => {
                // ÂçïÊåáÊªëÂä®
                if (e.touches.length === 1) {
                    const deltaX = e.touches[0].clientX - touchStartX;
                    const deltaY = e.touches[0].clientY - touchStartY;

                    if (STATE.mode === 'FOCUS') {
                        // FOCUSÊ®°Âºè‰∏ãÔºöÂçïÊåáÊãñÂä®ÁßªÂä®ÁÖßÁâá
                        STATE.handPinch.offsetX -= deltaX * FOCUS_PAN_SENSITIVITY;
                        STATE.handPinch.offsetY += deltaY * FOCUS_PAN_SENSITIVITY;

                        // ÈôêÂà∂Âπ≥ÁßªËåÉÂõ¥
                        const maxOffset = 5;
                        STATE.handPinch.offsetX = Math.max(-maxOffset, Math.min(maxOffset, STATE.handPinch.offsetX));
                        STATE.handPinch.offsetY = Math.max(-maxOffset, Math.min(maxOffset, STATE.handPinch.offsetY));
                    } else {
                        // ÂÖ∂‰ªñÊ®°ÂºèÔºöÂçïÊåáÊªëÂä®ÊóãËΩ¨
                        STATE.rotation.y += deltaX * 0.005;
                        STATE.rotation.x += deltaY * 0.002;
                        STATE.rotation.x = Math.max(-0.5, Math.min(0.5, STATE.rotation.x));
                    }

                    touchStartX = e.touches[0].clientX;
                    touchStartY = e.touches[0].clientY;
                }
            }, { passive: true });

            // ÂèåÊåáÁº©ÊîæÂäüËÉΩ
            let initialPinchDistance = 0;
            let isPinching = false;
            const MIN_ZOOM = 0.5;
            const MAX_ZOOM = 3;

            canvas.addEventListener('touchstart', (e) => {
                if (e.touches.length === 2) {
                    isPinching = true;
                    initialPinchDistance = Math.hypot(
                        e.touches[0].clientX - e.touches[1].clientX,
                        e.touches[0].clientY - e.touches[1].clientY
                    );
                }
            }, { passive: true });

            canvas.addEventListener('touchmove', (e) => {
                if (e.touches.length === 2 && isPinching) {
                    // ËÆ°ÁÆóÂΩìÂâçÂèåÊåáË∑ùÁ¶ª
                    const currentDistance = Math.hypot(
                        e.touches[0].clientX - e.touches[1].clientX,
                        e.touches[0].clientY - e.touches[1].clientY
                    );

                    // ËÆ°ÁÆóÁº©ÊîæÊØî‰æã
                    if (initialPinchDistance > 0) {
                        const scale = currentDistance / initialPinchDistance;
                        STATE.pinch.zoom = Math.max(MIN_ZOOM, Math.min(MAX_ZOOM, STATE.pinch.zoom * (1 + (scale - 1) * 0.05)));
                        initialPinchDistance = currentDistance;
                    }

                    // Â∫îÁî®Áº©ÊîæÂà∞Áõ∏Êú∫FOV
                    const baseFov = 42;
                    camera.fov = baseFov / STATE.pinch.zoom;
                    camera.updateProjectionMatrix();
                }
            }, { passive: true });

            canvas.addEventListener('touchend', (e) => {
                if (e.touches.length < 2) {
                    isPinching = false;
                }
            }, { passive: true });

            // ÂàùÂßãÂåñÊåâÈíÆÁä∂ÊÄÅ
            updateMobileButtonState();
        }

        // ========== PCÁ´ØÈº†Ê†áÊéßÂà∂ ==========
        function setupMouseControls() {
            const canvas = document.getElementById('canvas-container');
            let isRightMouseDown = false;
            let isLeftMouseDown = false;
            let mouseStartX = 0;
            let mouseStartY = 0;
            const MIN_ZOOM = 0.5;
            const MAX_ZOOM = 3;
            const PAN_SENSITIVITY = 0.01;

            // Á¶ÅÁî®Âè≥ÈîÆËèúÂçï
            canvas.addEventListener('contextmenu', (e) => {
                e.preventDefault();
            });

            // Èº†Ê†áÊåâ‰∏ã
            canvas.addEventListener('mousedown', (e) => {
                mouseStartX = e.clientX;
                mouseStartY = e.clientY;
                if (e.button === 0) { // Â∑¶ÈîÆ
                    isLeftMouseDown = true;
                    canvas.style.cursor = 'grab';
                } else if (e.button === 2) { // Âè≥ÈîÆ
                    isRightMouseDown = true;
                    canvas.style.cursor = 'move';
                }
            });

            // Èº†Ê†áÁßªÂä® - Â∑¶ÈîÆÊóãËΩ¨/Âπ≥ÁßªÔºåÂè≥ÈîÆÂπ≥Áßª
            canvas.addEventListener('mousemove', (e) => {
                const deltaX = e.clientX - mouseStartX;
                const deltaY = e.clientY - mouseStartY;

                if (isLeftMouseDown) {
                    if (STATE.mode === 'FOCUS') {
                        // FOCUSÊ®°Âºè‰∏ãÂ∑¶ÈîÆÊãñÂä®Âπ≥ÁßªÁÖßÁâá
                        STATE.handPinch.offsetX -= deltaX * PAN_SENSITIVITY;
                        STATE.handPinch.offsetY += deltaY * PAN_SENSITIVITY;

                        const maxOffset = 5;
                        STATE.handPinch.offsetX = Math.max(-maxOffset, Math.min(maxOffset, STATE.handPinch.offsetX));
                        STATE.handPinch.offsetY = Math.max(-maxOffset, Math.min(maxOffset, STATE.handPinch.offsetY));
                    } else {
                        // ÂÖ∂‰ªñÊ®°ÂºèÂ∑¶ÈîÆÊãñÂä®ÊóãËΩ¨
                        STATE.rotation.y += deltaX * 0.005;
                        STATE.rotation.x += deltaY * 0.002;
                        STATE.rotation.x = Math.max(-0.5, Math.min(0.5, STATE.rotation.x));
                    }
                    mouseStartX = e.clientX;
                    mouseStartY = e.clientY;
                } else if (isRightMouseDown) {
                    // Âè≥ÈîÆÊãñÂä®Âπ≥ÁßªÔºàÈùûFOCUSÊ®°ÂºèÔºâ
                    STATE.pinch.offsetX += deltaX * PAN_SENSITIVITY / STATE.pinch.zoom;
                    STATE.pinch.offsetY -= deltaY * PAN_SENSITIVITY / STATE.pinch.zoom;

                    // ÈôêÂà∂Âπ≥ÁßªËåÉÂõ¥
                    const maxOffset = 10 / STATE.pinch.zoom;
                    STATE.pinch.offsetX = Math.max(-maxOffset, Math.min(maxOffset, STATE.pinch.offsetX));
                    STATE.pinch.offsetY = Math.max(-maxOffset, Math.min(maxOffset, STATE.pinch.offsetY));

                    mouseStartX = e.clientX;
                    mouseStartY = e.clientY;
                }
            });

            // Èº†Ê†áÈáäÊîæ
            canvas.addEventListener('mouseup', (e) => {
                if (e.button === 0) {
                    isLeftMouseDown = false;
                    canvas.style.cursor = 'default';
                } else if (e.button === 2) {
                    isRightMouseDown = false;
                    canvas.style.cursor = 'default';
                }
            });

            // Èº†Ê†áÁ¶ªÂºÄÁîªÂ∏É
            canvas.addEventListener('mouseleave', () => {
                isRightMouseDown = false;
                isLeftMouseDown = false;
                canvas.style.cursor = 'default';
            });

            // ÊªöËΩÆÁº©Êîæ
            canvas.addEventListener('wheel', (e) => {
                e.preventDefault();

                // Ê†πÊçÆÊªöËΩÆÊñπÂêëË∞ÉÊï¥Áº©Êîæ
                const zoomDelta = e.deltaY > 0 ? -0.1 : 0.1;
                STATE.pinch.zoom = Math.max(MIN_ZOOM, Math.min(MAX_ZOOM, STATE.pinch.zoom + zoomDelta));

                // Â∫îÁî®Áº©ÊîæÂà∞Áõ∏Êú∫FOV
                const baseFov = 42;
                camera.fov = baseFov / STATE.pinch.zoom;
                camera.updateProjectionMatrix();
            }, { passive: false });

        }

        // ========== ÂèåÂáªÈöêËóèUI ==========
        function setupDoubleClickHideUI() {
            const canvas = document.getElementById('canvas-container');

            // PCÁ´ØÂèåÂáªÈöêËóèUI
            canvas.addEventListener('dblclick', (e) => {
                // Ê£ÄÊü•ÁÇπÂáªÁöÑÊòØÂê¶ÊòØcanvasÂå∫ÂüüÔºà‰∏çÊòØÊåâÈíÆÁ≠âUIÂÖÉÁ¥†Ôºâ
                if (e.target === canvas || e.target.tagName === 'CANVAS') {
                    toggleAllUI();
                }
            });

            // ÁßªÂä®Á´ØÂèåÂáªÈöêËóèUI
            let lastTouchTime = 0;
            let touchCount = 0;
            const DOUBLE_TAP_DELAY = 300; // ÂèåÂáªÈó¥ÈöîÊó∂Èó¥

            canvas.addEventListener('touchend', (e) => {
                // Âè™Â§ÑÁêÜÂçïÊåáËß¶Êë∏
                if (e.changedTouches.length !== 1) return;

                const currentTime = new Date().getTime();
                const tapLength = currentTime - lastTouchTime;

                if (tapLength < DOUBLE_TAP_DELAY && tapLength > 0) {
                    // ÂèåÂáªÊ£ÄÊµãÊàêÂäü
                    touchCount++;
                    if (touchCount >= 1) {
                        toggleAllUI();
                        touchCount = 0;
                        e.preventDefault();
                    }
                } else {
                    touchCount = 0;
                }

                lastTouchTime = currentTime;
            }, { passive: false });
        }

        // Èü≥‰πêÁÆ°ÁêÜÂäüËÉΩ
        const MUSIC_PLAYLIST = [
            { name: 'EXO - Ï≤´ Îàà The First Snow', src: 'EXO - Ï≤´ Îàà The First Snow.mp3' },
            { name: 'Christmas Background', src: 'christmas-christmas-background-music-449476.mp3' },
            { name: 'We Wish You A Merry Christmas', src: 'we-wish-you-a-merry-christmas-444573.mp3' }
        ];

        let currentTrackIndex = 0;
        let currentMusicName = MUSIC_PLAYLIST[0].name;
        let musicEnabled = true;
        let musicAutoplay = true;
        let targetVolume = 0.5;
        let isFading = false;
        const FADE_DURATION = 1500; // Ê∑°ÂÖ•Ê∑°Âá∫Êó∂Èïø(ms)

        function setupMusicManagement() {
            const modal = document.getElementById('music-modal');
            const bgMusic = document.getElementById('bg-music');
            const mainMusicBtn = document.getElementById('music-btn');
            const visualizer = document.getElementById('music-visualizer');

            // ÂàùÂßãÂåñÁ¨¨‰∏ÄÈ¶ñÊ≠å
            bgMusic.src = MUSIC_PLAYLIST[0].src;
            bgMusic.volume = 0;

            // Ê®°ÊÄÅÊ°ÜÂÖ≥Èó≠ÊåâÈíÆ
            document.getElementById('music-modal-close').addEventListener('click', () => modal.classList.remove('show'));
            document.getElementById('music-close-btn').addEventListener('click', () => modal.classList.remove('show'));
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.classList.remove('show');
            });

            // TabÂàáÊç¢
            const tabs = document.querySelectorAll('.music-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    const tabId = tab.dataset.tab;
                    document.getElementById('tab-url').style.display = tabId === 'url' ? 'block' : 'none';
                    document.getElementById('tab-upload').style.display = tabId === 'upload' ? 'block' : 'none';
                });
            });

            // Â∫îÁî®URLÊåâÈíÆ
            document.getElementById('apply-url-btn').addEventListener('click', () => {
                const urlInput = document.getElementById('music-url-input');
                const url = urlInput.value.trim();
                if (!url) { alert('ËØ∑ËæìÂÖ•Èü≥‰πêÈìæÊé•ÔºÅ'); return; }
                try { new URL(url); } catch { alert('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑURLÈìæÊé•ÔºÅ'); return; }
                applyMusicSource(url, getFileNameFromUrl(url));
            });

            // Èü≥È¢ëÊñá‰ª∂‰∏ä‰º†Âå∫Âüü
            const uploadArea = document.getElementById('music-upload-area');
            const fileInput = document.getElementById('music-file-input');
            uploadArea.addEventListener('click', () => fileInput.click());
            uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
            uploadArea.addEventListener('dragleave', () => { uploadArea.classList.remove('dragover'); });
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file && file.type.startsWith('audio/')) handleAudioFile(file);
                else alert('ËØ∑‰∏ä‰º†Èü≥È¢ëÊñá‰ª∂ÔºÅ');
            });
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) handleAudioFile(file);
                e.target.value = '';
            });

            function handleAudioFile(file) {
                const reader = new FileReader();
                reader.onload = (e) => applyMusicSource(e.target.result, file.name);
                reader.readAsDataURL(file);
            }

            function applyMusicSource(src, name) {
                fadeOut(() => {
                    bgMusic.src = src;
                    currentMusicName = name || 'Ëá™ÂÆö‰πâÈü≥‰πê';
                    updateMusicInfo();
                    if (musicEnabled) fadeIn();
                });
                alert(`Â∑≤Â∫îÁî®Èü≥‰πê: ${name}`);
            }

            // Ê∑°ÂÖ•ÊïàÊûú
            function fadeIn(callback) {
                if (isFading) return;
                isFading = true;
                bgMusic.volume = 0;
                bgMusic.play().catch(err => { console.log('Êí≠ÊîæÂ§±Ë¥•:', err); isFading = false; return; });

                const startTime = Date.now();
                const fade = () => {
                    const elapsed = Date.now() - startTime;
                    const progress = Math.min(elapsed / FADE_DURATION, 1);
                    bgMusic.volume = progress * targetVolume;
                    if (progress < 1) requestAnimationFrame(fade);
                    else { isFading = false; if (callback) callback(); }
                };
                fade();
            }

            // Ê∑°Âá∫ÊïàÊûú
            function fadeOut(callback) {
                if (bgMusic.paused || bgMusic.volume === 0) { if (callback) callback(); return; }
                isFading = true;
                const startVolume = bgMusic.volume;
                const startTime = Date.now();
                const fade = () => {
                    const elapsed = Date.now() - startTime;
                    const progress = Math.min(elapsed / FADE_DURATION, 1);
                    bgMusic.volume = startVolume * (1 - progress);
                    if (progress < 1) requestAnimationFrame(fade);
                    else { bgMusic.pause(); isFading = false; if (callback) callback(); }
                };
                fade();
            }

            // Êí≠Êîæ‰∏ã‰∏ÄÈ¶ñ
            function playNext() {
                currentTrackIndex = (currentTrackIndex + 1) % MUSIC_PLAYLIST.length;
                const track = MUSIC_PLAYLIST[currentTrackIndex];
                fadeOut(() => {
                    bgMusic.src = track.src;
                    currentMusicName = track.name;
                    updateMusicInfo();
                    if (musicEnabled) fadeIn();
                });
            }

            // Ê≠åÊõ≤ÁªìÊùüÊó∂Ëá™Âä®Êí≠Êîæ‰∏ã‰∏ÄÈ¶ñ
            bgMusic.addEventListener('ended', () => {
                if (musicEnabled) playNext();
            });

            // Êí≠Êîæ/ÊöÇÂÅúÊéßÂà∂
            const playBtn = document.getElementById('music-play-btn');
            const pauseBtn = document.getElementById('music-pause-btn');

            playBtn.addEventListener('click', () => {
                if (!musicEnabled) return;
                fadeIn();
            });

            pauseBtn.addEventListener('click', () => {
                fadeOut();
            });

            // ‰∏ã‰∏ÄÈ¶ñÊåâÈíÆ
            document.getElementById('music-next-btn').addEventListener('click', () => {
                playNext();
            });

            // ÁõëÂê¨Èü≥È¢ëÁä∂ÊÄÅÂèòÂåñ
            bgMusic.addEventListener('play', () => updatePlayState(true));
            bgMusic.addEventListener('pause', () => updatePlayState(false));

            function updatePlayState(playing) {
                const widgetPlayBtn = document.getElementById('widget-play-btn');
                if (playing) {
                    playBtn.classList.add('playing');
                    mainMusicBtn.classList.add('active');
                    visualizer.classList.remove('paused');
                    if (widgetPlayBtn) widgetPlayBtn.textContent = '‚è∏';
                } else {
                    playBtn.classList.remove('playing');
                    mainMusicBtn.classList.remove('active');
                    visualizer.classList.add('paused');
                    if (widgetPlayBtn) widgetPlayBtn.textContent = '‚ñ∂';
                }
            }

            // Èü≥‰πêÂ∞èÈÉ®‰ª∂ÊéßÂà∂
            const musicWidget = document.getElementById('music-widget');
            const widgetPlayBtn = document.getElementById('widget-play-btn');
            const widgetNextBtn = document.getElementById('widget-next-btn');
            const widgetSettingsBtn = document.getElementById('widget-settings-btn');
            const widgetMusicName = document.getElementById('music-widget-name');

            // Ê£ÄÊµãÊòØÂê¶ÁßªÂä®Á´Ø
            const isMobileDevice = () => window.innerWidth <= 768;

            // ÁÇπÂáªÂä®ÊïàÂå∫Âüü - ÁßªÂä®Á´ØÂ±ïÂºÄ/Êî∂Ëµ∑ÔºåPCÁ´ØÊí≠Êîæ/ÊöÇÂÅú
            document.querySelector('.music-widget-main').addEventListener('click', () => {
                if (!musicEnabled) return;
                if (isMobileDevice()) {
                    // ÁßªÂä®Á´ØÔºöÂàáÊç¢Â±ïÂºÄÁä∂ÊÄÅ
                    musicWidget.classList.toggle('expanded');
                } else {
                    // PCÁ´ØÔºöÊí≠Êîæ/ÊöÇÂÅú
                    if (bgMusic.paused) fadeIn();
                    else fadeOut();
                }
            });

            // ÁÇπÂáªÂÖ∂‰ªñÂú∞ÊñπÊî∂Ëµ∑ÁßªÂä®Á´ØÂ±ïÂºÄÁöÑÈù¢Êùø
            document.addEventListener('click', (e) => {
                if (isMobileDevice() && !musicWidget.contains(e.target)) {
                    musicWidget.classList.remove('expanded');
                }
            });

            // Êí≠Êîæ/ÊöÇÂÅúÊåâÈíÆ
            widgetPlayBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                if (!musicEnabled) return;
                if (bgMusic.paused) fadeIn();
                else fadeOut();
            });

            // ‰∏ã‰∏ÄÈ¶ñÊåâÈíÆ
            widgetNextBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                playNext();
            });

            // ËÆæÁΩÆÊåâÈíÆ
            widgetSettingsBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                modal.classList.add('show');
            });

            // Èü≥ÈáèÊéßÂà∂
            const volumeSlider = document.getElementById('music-volume');
            const volumeValue = document.getElementById('volume-value');

            volumeSlider.addEventListener('input', () => {
                targetVolume = volumeSlider.value / 100;
                if (!bgMusic.paused && !isFading) bgMusic.volume = targetVolume;
                volumeValue.textContent = volumeSlider.value + '%';
                localStorage.setItem('musicVolume', volumeSlider.value);
            });

            // ÊÅ¢Â§çÈªòËÆ§
            document.getElementById('music-reset-btn').addEventListener('click', () => {
                if (confirm('Á°ÆÂÆöË¶ÅÊÅ¢Â§çÈªòËÆ§Êí≠ÊîæÂàóË°®ÂêóÔºü')) {
                    currentTrackIndex = 0;
                    const track = MUSIC_PLAYLIST[0];
                    fadeOut(() => {
                        bgMusic.src = track.src;
                        currentMusicName = track.name;
                        updateMusicInfo();
                        document.getElementById('music-url-input').value = '';
                        localStorage.removeItem('musicSrc');
                        localStorage.removeItem('musicName');
                        if (musicEnabled) fadeIn();
                    });
                    alert('Â∑≤ÊÅ¢Â§çÈªòËÆ§Êí≠ÊîæÂàóË°®');
                }
            });

            function updateMusicInfo() {
                document.getElementById('current-music-name').textContent = currentMusicName;
                widgetMusicName.textContent = currentMusicName;
            }

            function getFileNameFromUrl(url) {
                try {
                    const pathname = new URL(url).pathname;
                    const filename = pathname.split('/').pop();
                    return decodeURIComponent(filename) || 'Âú®Á∫øÈü≥‰πê';
                } catch { return 'Âú®Á∫øÈü≥‰πê'; }
            }

            // ËÆæÁΩÆÈù¢Êùø‰∏≠ÁöÑÈü≥‰πêÂºÄÂÖ≥
            const musicEnabledCheckbox = document.getElementById('cfg-music-enabled');
            const musicAutoplayCheckbox = document.getElementById('cfg-music-autoplay');

            if (musicEnabledCheckbox) {
                musicEnabledCheckbox.addEventListener('change', () => {
                    musicEnabled = musicEnabledCheckbox.checked;
                    localStorage.setItem('musicEnabled', musicEnabled);
                    if (!musicEnabled) {
                        fadeOut();
                        musicWidget.style.display = 'none';
                    } else {
                        musicWidget.style.display = 'flex';
                        if (musicAutoplay) fadeIn();
                    }
                });
            }

            if (musicAutoplayCheckbox) {
                musicAutoplayCheckbox.addEventListener('change', () => {
                    musicAutoplay = musicAutoplayCheckbox.checked;
                    localStorage.setItem('musicAutoplay', musicAutoplay);
                });
            }

            // ÊÅ¢Â§çËÆæÁΩÆ
            function restoreMusicSettings() {
                const savedVolume = localStorage.getItem('musicVolume');
                const savedEnabled = localStorage.getItem('musicEnabled');
                const savedAutoplay = localStorage.getItem('musicAutoplay');

                if (savedVolume) {
                    volumeSlider.value = savedVolume;
                    targetVolume = savedVolume / 100;
                    volumeValue.textContent = savedVolume + '%';
                } else {
                    targetVolume = 0.5;
                }

                if (savedEnabled !== null) {
                    musicEnabled = savedEnabled === 'true';
                    if (musicEnabledCheckbox) musicEnabledCheckbox.checked = musicEnabled;
                }

                if (savedAutoplay !== null) {
                    musicAutoplay = savedAutoplay === 'true';
                    if (musicAutoplayCheckbox) musicAutoplayCheckbox.checked = musicAutoplay;
                }

                if (!musicEnabled) {
                    musicWidget.style.display = 'none';
                }

                updateMusicInfo();
            }

            restoreMusicSettings();

            // Áî®Êà∑‰∫§‰∫íÂêéËá™Âä®Êí≠Êîæ
            const startMusic = () => {
                if (musicEnabled && musicAutoplay && bgMusic.paused) {
                    fadeIn();
                }
                document.removeEventListener('click', startMusic);
                document.removeEventListener('touchstart', startMusic);
            };
            document.addEventListener('click', startMusic);
            document.addEventListener('touchstart', startMusic);
        }

        // ‰ªéÁºìÂ≠òÊÅ¢Â§çÁÖßÁâáÂà∞Âú∫ÊôØ
        async function restorePhotosFromCache() {
            const photos = await PhotoCache.getAllPhotos();

            for (const photo of photos) {
                if (photo.inScene) {
                    await new Promise((resolve) => {
                        new THREE.TextureLoader().load(photo.base64, (texture) => {
                            texture.colorSpace = THREE.SRGBColorSpace;
                            addPhotoToScene(texture, photo.base64, photo.id);
                            resolve();
                        });
                    });
                }
            }

            if (photos.length > 0) {
                console.log(`Â∑≤‰ªéÁºìÂ≠òÊÅ¢Â§ç ${photos.filter(p => p.inScene).length} Âº†ÁÖßÁâá`);
            }
        }

        // Âä†ËΩΩÈ¢ÑÁΩÆÁÖßÁâáÔºàÊ∫ê‰ª£Á†Å‰∏≠ÂµåÂÖ•ÁöÑÁÖßÁâáÔºâ
        async function loadPresetPhotos() {
            if (!PRESET_PHOTOS || PRESET_PHOTOS.length === 0) {
                return;
            }

            console.log(`Ê≠£Âú®Âä†ËΩΩ ${PRESET_PHOTOS.length} Âº†È¢ÑÁΩÆÁÖßÁâá...`);
            let loadedCount = 0;

            for (const base64 of PRESET_PHOTOS) {
                if (!base64 || !base64.startsWith('data:image')) {
                    continue;
                }

                // Ê£ÄÊü•ÊòØÂê¶Â∑≤Â≠òÂú®‰∫éÁºìÂ≠ò‰∏≠ÔºàÈÄöËøáÊØîËæÉbase64ÁöÑÂâç100‰∏™Â≠óÁ¨¶Êù•Âà§Êñ≠Ôºâ
                const photos = await PhotoCache.getAllPhotos();
                const exists = photos.some(p => p.base64.substring(0, 100) === base64.substring(0, 100));

                if (!exists) {
                    // ‰øùÂ≠òÂà∞ÁºìÂ≠ò
                    const result = await PhotoCache.savePhoto(base64);
                    if (result.success) {
                        await new Promise((resolve) => {
                            new THREE.TextureLoader().load(base64, (texture) => {
                                texture.colorSpace = THREE.SRGBColorSpace;
                                addPhotoToScene(texture, base64, result.photo.id);
                                loadedCount++;
                                resolve();
                            });
                        });
                    }
                }
            }

            if (loadedCount > 0) {
                console.log(`Â∑≤Âä†ËΩΩ ${loadedCount} Âº†È¢ÑÁΩÆÁÖßÁâá`);
            }
        }

        // ÂàùÂßãÂåñ MediaPipe ÊâãÂäøËØÜÂà´
        async function initMediaPipe() {
            try {
                const vision = await FilesetResolver.forVisionTasks(
                    "https://testingcf.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm"
                );

                handLandmarker = await HandLandmarker.createFromOptions(vision, {
                    baseOptions: {
                        modelAssetPath: `https://testingcf.jsdelivr.net/gh/CJcrazycool/mediapipe-mirror@main/hand_landmarker.task`,
                        delegate: "GPU"
                    },
                    runningMode: "VIDEO",
                    numHands: 1
                });

                if (navigator.mediaDevices?.getUserMedia) {
                    video = document.getElementById('webcam');
                    video.srcObject = await navigator.mediaDevices.getUserMedia({ video: true });
                    webcamCanvas = document.getElementById('webcam-preview');
                    webcamCtx = webcamCanvas.getContext('2d');
                    video.addEventListener("loadeddata", predictWebcam);
                }
            } catch (error) {
                console.warn('ÊëÑÂÉèÂ§¥ÊàñÊâãÂäøËØÜÂà´ÂàùÂßãÂåñÂ§±Ë¥•ÔºåÂ∞ÜÁ¶ÅÁî®ÊâãÂäøÂäüËÉΩ:', error.message);
                // ÈöêËóèÊëÑÂÉèÂ§¥È¢ÑËßàÂå∫Âüü
                const webcamWrapper = document.getElementById('webcam-wrapper');
                if (webcamWrapper) webcamWrapper.style.display = 'none';
            }
        }

        // ÊâãÂäøËØÜÂà´Âæ™ÁéØ
        let lastTime = -1;
        async function predictWebcam() {
            if (video.currentTime !== lastTime && handLandmarker) {
                lastTime = video.currentTime;
                webcamCanvas.width = video.videoWidth;
                webcamCanvas.height = video.videoHeight;

                webcamCtx.save();
                webcamCtx.clearRect(0, 0, webcamCanvas.width, webcamCanvas.height);
                webcamCtx.drawImage(video, 0, 0);

                const result = handLandmarker.detectForVideo(video, performance.now());

                if (result.landmarks.length) {
                    STATE.hand.detected = true;
                    STATE.hand.x = (result.landmarks[0][9].x - 0.5) * 2;
                    STATE.hand.y = (result.landmarks[0][9].y - 0.5) * 2;

                    const wrist = result.landmarks[0][0];
                    const index = result.landmarks[0][8];
                    const thumb = result.landmarks[0][4];

                    const indexDist = Math.hypot(index.x - wrist.x, index.y - wrist.y);
                    const thumbDist = Math.hypot(thumb.x - index.x, thumb.y - index.y);

                    const isFist = indexDist < 0.3 && thumbDist > 0.08;
                    const isOpen = indexDist > 0.4;
                    const isPinch = thumbDist < 0.08;

                    // ÊâãÂäøÈÄªËæë
                    if (isPinch && (STATE.mode === 'SCATTER' || STATE.mode === 'FOCUS')) {
                        STATE.mode = 'FOCUS';
                        STATE.handPinch.active = true;

                        // Âú®FOCUSÊ®°Âºè‰∏ãÔºåÊçèÂêàÊâãÂäøÁöÑ‰ΩçÁΩÆÊéßÂà∂ÈïúÂ§¥Âπ≥Áßª
                        // ‰ΩøÁî®ÊçèÂêàÁÇπÔºàÊãáÊåáÂíåÈ£üÊåá‰∏≠ÁÇπÔºâÁöÑ‰ΩçÁΩÆ
                        const pinchX = (thumb.x + index.x) / 2;
                        const pinchY = (thumb.y + index.y) / 2;

                        // Â∞ÜÊâãÁöÑ‰ΩçÁΩÆÊò†Â∞ÑÂà∞ÈïúÂ§¥ÂÅèÁßªÔºàËåÉÂõ¥Á∫¶ -2 Âà∞ 2Ôºâ
                        // ÊâãÂú®ÁîªÈù¢‰∏≠ÂøÉÊó∂ÂÅèÁßª‰∏∫0ÔºåÂêëËæπÁºòÁßªÂä®Êó∂ÂÅèÁßªÂ¢ûÂä†
                        const targetOffsetX = (pinchX - 0.5) * -4; // ÂèçÂêëÔºåÊâãÂêëÂè≥ÈïúÂ§¥ÂêëÂ∑¶
                        const targetOffsetY = (pinchY - 0.5) * -3; // ÂèçÂêëÔºåÊâãÂêë‰∏ãÈïúÂ§¥Âêë‰∏ä

                        // Âπ≥ÊªëËøáÊ∏°Âà∞ÁõÆÊ†áÂÅèÁßª
                        STATE.handPinch.offsetX += (targetOffsetX - STATE.handPinch.offsetX) * 0.1;
                        STATE.handPinch.offsetY += (targetOffsetY - STATE.handPinch.offsetY) * 0.1;

                        if (!STATE.focusTarget) {
                            const photos = particleSystem.filter(p => p.type === 'PHOTO');
                            if (photos.length) {
                                STATE.focusTarget = photos[Math.floor(Math.random() * photos.length)].mesh;
                            }
                        }
                    } else if (isFist) {
                        STATE.mode = 'TREE';
                        STATE.focusTarget = null;
                        STATE.handPinch.active = false;
                        // ÈáçÁΩÆÊâãÂäøÂπ≥ÁßªÂÅèÁßª
                        STATE.handPinch.offsetX = 0;
                        STATE.handPinch.offsetY = 0;
                    } else if (isOpen) {
                        STATE.mode = 'SCATTER';
                        STATE.focusTarget = null;
                        STATE.handPinch.active = false;
                        // ÈáçÁΩÆÊâãÂäøÂπ≥ÁßªÂÅèÁßª
                        STATE.handPinch.offsetX = 0;
                        STATE.handPinch.offsetY = 0;
                    }

                    // ÁªòÂà∂ÊâãÈÉ®È™®Êû∂
                    const landmarks = result.landmarks[0];
                    const connections = [
                        [0, 1], [1, 2], [2, 3], [3, 4],
                        [0, 5], [5, 6], [6, 7], [7, 8],
                        [0, 9], [9, 10], [10, 11], [11, 12],
                        [0, 13], [13, 14], [14, 15], [15, 16],
                        [0, 17], [17, 18], [18, 19], [19, 20],
                        [5, 9], [9, 13], [13, 17]
                    ];

                    // Ëé∑ÂèñÂΩìÂâç‰∏ªÈ¢òÁöÑÂº∫Ë∞ÉËâ≤
                    const accentColor = getComputedStyle(document.documentElement).getPropertyValue('--accent-color').trim() || '#00ffcc';
                    const accentRgb = getComputedStyle(document.documentElement).getPropertyValue('--accent-color-rgb').trim() || '0, 255, 204';

                    webcamCtx.shadowBlur = 8;
                    webcamCtx.shadowColor = accentColor;
                    webcamCtx.lineWidth = 3;
                    webcamCtx.strokeStyle = `rgba(${accentRgb}, 0.9)`;

                    for (let [s, e] of connections) {
                        webcamCtx.beginPath();
                        webcamCtx.moveTo(
                            landmarks[s].x * webcamCanvas.width,
                            landmarks[s].y * webcamCanvas.height
                        );
                        webcamCtx.lineTo(
                            landmarks[e].x * webcamCanvas.width,
                            landmarks[e].y * webcamCanvas.height
                        );
                        webcamCtx.stroke();
                    }

                    // ÁªòÂà∂ÂÖ≥ÈîÆËäÇÁÇπ
                    webcamCtx.fillStyle = `rgba(${accentRgb}, 0.8)`;
                    for (let i of [0, 4, 8, 12, 16, 20]) {
                        webcamCtx.beginPath();
                        webcamCtx.arc(
                            landmarks[i].x * webcamCanvas.width,
                            landmarks[i].y * webcamCanvas.height,
                            4,
                            0,
                            2 * Math.PI
                        );
                        webcamCtx.fill();
                    }

                    webcamCtx.shadowBlur = 0;
                }

                webcamCtx.restore();
            }
            requestAnimationFrame(predictWebcam);
        }
        // Âä®ÁîªÂæ™ÁéØ
        function animate() {
            requestAnimationFrame(animate);
            const dt = clock.getDelta();

            // FOCUSÊ®°Âºè - ÁÖßÁâáÂ±Ö‰∏≠ÊòæÁ§∫
            if (STATE.mode === 'FOCUS' && STATE.focusTarget) {
                bloomPass.strength = THREE.MathUtils.lerp(bloomPass.strength, 0.6, 5 * dt);

                // Ëé∑ÂèñÁõÆÊ†áÁÖßÁâáÁöÑ‰∏ñÁïåÂùêÊ†á
                const targetWorldPos = new THREE.Vector3();
                STATE.focusTarget.getWorldPosition(targetWorldPos);

                // Áõ∏Êú∫Ë∑ùÁ¶ª
                const cameraDistance = CONFIG.focusDistance;

                // Âú®FOCUSÊ®°Âºè‰∏ãÔºåÂ∫îÁî®Âπ≥ÁßªÂÅèÁßªÔºàÊîØÊåÅÊâãÂäøÊçèÂêàÂíåËß¶Êë∏ÊãñÂä®Ôºâ
                const handOffsetX = STATE.handPinch.offsetX;
                const handOffsetY = STATE.handPinch.offsetY;

                // Áõ∏Êú∫‰ΩçÁΩÆÔºö‰ªéÊ≠£ÂâçÊñπÁúãÂêëÁÖßÁâáÔºåZËΩ¥Âõ∫ÂÆö
                STATE.camera.targetPos.set(
                    targetWorldPos.x + handOffsetX,
                    targetWorldPos.y + handOffsetY,
                    targetWorldPos.z + cameraDistance
                );
                STATE.camera.targetLookAt.set(
                    targetWorldPos.x + handOffsetX,
                    targetWorldPos.y + handOffsetY,
                    targetWorldPos.z
                );
            } else {
                // ÈùûFOCUSÊ®°Âºè
                bloomPass.strength = THREE.MathUtils.lerp(bloomPass.strength, CONFIG.bloomStrength, 2 * dt);

                // ÁßªÂä®Á´ØÂíåPCÁ´Ø‰ΩøÁî®‰∏çÂêåÁöÑÈªòËÆ§Ë∑ùÁ¶ª
                const isMobile = window.innerWidth <= 768;
                let camZ;
                if (STATE.mode === 'SCATTER') {
                    camZ = isMobile ? CONFIG.scatterDistance * 1.6 : CONFIG.scatterDistance;
                } else {
                    // Ê†ëÊ®°ÂºèÔºöÁßªÂä®Á´ØÈªòËÆ§30ÔºåPCÁ´Ø‰ΩøÁî®ÈÖçÁΩÆÂÄº
                    camZ = isMobile ? 45 : CONFIG.treeDistance;
                }

                // ‰øùÁïôÊçèÂêàÂπ≥ÁßªÁöÑÂÅèÁßªÈáèÔºåÁõ∏Êú∫ÁúãÂêëÊ†ëÁöÑ‰∏≠ÂøÉ‰ΩçÁΩÆ
                STATE.camera.targetPos.set(STATE.pinch.offsetX, 3 + STATE.pinch.offsetY, camZ);
                STATE.camera.targetLookAt.set(STATE.pinch.offsetX, 1 + STATE.pinch.offsetY, 0);
            }

            // Áõ∏Êú∫Âπ≥ÊªëÁßªÂä®
            camera.position.lerp(STATE.camera.targetPos, 1 * dt);
            STATE.camera.currentLookAt.lerp(STATE.camera.targetLookAt, 1.5 * dt);
            camera.lookAt(STATE.camera.currentLookAt);

            // ÊóãËΩ¨ÊéßÂà∂
            if (STATE.mode !== 'FOCUS') {
                if (STATE.mode === 'SCATTER' && STATE.hand.detected) {
                    STATE.rotation.x += (STATE.hand.y * 0.8 - STATE.rotation.x) * 1 * dt;
                    STATE.rotation.y += (STATE.hand.x * 2.5 - STATE.rotation.y) * 1 * dt;
                } else {
                    STATE.rotation.y += (STATE.mode === 'TREE' ? CONFIG.treeRotate : CONFIG.scatterRotate) * dt;
                    STATE.rotation.x += (0 - STATE.rotation.x) * 2 * dt;
                }
                mainGroup.rotation.y = STATE.rotation.y;
                mainGroup.rotation.x = STATE.rotation.x;
            } else {
                mainGroup.rotation.y += 0.05 * dt;
            }

            // È°∂ÈÉ®ÊòüÊòüÂä®Áîª
            if (window.topStar) {
                const time = clock.elapsedTime;
                // ÁºìÊÖ¢ÊóãËΩ¨
                window.topStar.rotation.z += 0.3 * dt;
                // ‰∏ä‰∏ãÊºÇÊµÆ
                window.topStar.position.y = 9 + Math.sin(time * 1.5) * 0.2;
                // ÊòüÊòüÊï¥‰ΩìÂèëÂÖâÈó™ÁÉÅ - ÊÖ¢ÊÖ¢ÂèòÂåñ
                const glowIntensity = CONFIG.starGlow + Math.sin(time * CONFIG.starBlink) * 1.0;
                MATERIALS.star.emissiveIntensity = glowIntensity;
                // ÁÇπÂÖâÊ∫êÂêåÊ≠•Èó™ÁÉÅ
                if (window.starLight) {
                    window.starLight.position.y = window.topStar.position.y;
                    window.starLight.intensity = 2 + Math.sin(time * 0.8) * 1.5;
                }
            }

            // Èõ™Ëä±Âä®Áîª
            if (snowSystem) {
                const positions = snowSystem.geometry.attributes.position.array;
                for (let i = 1; i < positions.length; i += 3) {
                    positions[i] -= CONFIG.snowSpeed;
                    if (positions[i] < -10) positions[i] = 40;
                }
                snowSystem.geometry.attributes.position.needsUpdate = true;
            }

            // Êõ¥Êñ∞Á≤íÂ≠ê
            particleSystem.forEach(p => p.update(dt, STATE.mode));
            composer.render();
        }

        function createTips() {
            const isMobile = window.innerWidth <= 768 || 'ontouchstart' in window;
            const tips = document.createElement('div');
            tips.id = 'tips';

            if (isMobile) {
                // ÁßªÂä®Á´ØÊèêÁ§∫
                tips.innerHTML = `
                    <div style="text-align:center; margin-bottom:10px; color:#fff; font-weight:bold;">Ëß¶Êë∏ÊéßÂà∂</div>
                    <div class="tip-item"><span class="tip-key">üéÑ</span> Âú£ËØûÊ†ëÊ®°Âºè</div>
                    <div class="tip-item"><span class="tip-key">‚ú®</span> ÊòüÊ≤≥Êï£ÂºÄ</div>
                    <div class="tip-item"><span class="tip-key">üì∑</span> ÈîÅÂÆöÁÖßÁâá</div>
                    <div class="tip-item"><span class="tip-key">‚è≠Ô∏è</span> ‰∏ã‰∏ÄÂº†</div>
                    <div class="tip-item"><span class="tip-key">ÂçïÊåáÊªëÂä®</span> ÊóãËΩ¨ËßÜËßí</div>
                    <div class="tip-item"><span class="tip-key">ÂèåÊåáÊçèÂêà</span> Áº©ÊîæÂ§ßÂ∞è</div>
                    <div class="tip-item"><span class="tip-key">ÂèåÂáª</span> ÈáçÁΩÆËßÜËßí</div>
                    <div style="text-align:center; margin-top:12px; padding-top:10px; border-top:1px solid rgba(255,255,255,0.1); color:rgba(0,255,204,0.6); font-size:9px;">
                        power by xiaohongshu-Ê≤´Ê≤´ & Gemini3pro
                    </div>
                `;
            } else {
                // Ê°åÈù¢Á´ØÊèêÁ§∫
                tips.innerHTML = `
                    <div style="text-align:center; margin-bottom:10px; color:#fff; font-weight:bold;">ÊâãÂäøÊéßÂà∂</div>
                    <div class="tip-item"><span class="tip-key">‚úä Êè°Êã≥</span> Âú£ËØûÊ†ë</div>
                    <div class="tip-item"><span class="tip-key">‚úã Âº†Êâã</span> ÊòüÊ≤≥Êï£ÂºÄ</div>
                    <div class="tip-item"><span class="tip-key">üëå ÊçèÂêà</span> ÈîÅÂÆöÁÖßÁâá</div>
                    <div class="keyboard-tips">
                        <div style="text-align:center; margin-top:12px; margin-bottom:10px; color:#fff; font-weight:bold; border-top:1px solid rgba(255,255,255,0.1); padding-top:10px;">Èº†Ê†áÊéßÂà∂</div>
                        <div class="tip-item"><span class="tip-key">Â∑¶ÈîÆÊãñÂä®</span> ÊóãËΩ¨ËßÜËßí</div>
                        <div class="tip-item"><span class="tip-key">Âè≥ÈîÆÊãñÂä®</span> Âπ≥ÁßªËßÜËßí</div>
                        <div class="tip-item"><span class="tip-key">ÊªöËΩÆ</span> Áº©ÊîæÂ§ßÂ∞è</div>
                        <div class="tip-item"><span class="tip-key">ÂèåÂáª</span> ÈáçÁΩÆËßÜËßí</div>
                        <div style="text-align:center; margin-top:12px; margin-bottom:10px; color:#fff; font-weight:bold; border-top:1px solid rgba(255,255,255,0.1); padding-top:10px;">ÈîÆÁõòÊéßÂà∂</div>
                        <div class="tip-item"><span class="tip-key">1 / T</span> Âú£ËØûÊ†ë</div>
                        <div class="tip-item"><span class="tip-key">2 / S</span> ÊòüÊ≤≥Êï£ÂºÄ</div>
                        <div class="tip-item"><span class="tip-key">3 / P</span> ÈîÅÂÆöÁÖßÁâá</div>
                        <div class="tip-item"><span class="tip-key">N</span> ‰∏ã‰∏ÄÂº†ÁÖßÁâá</div>
                        <div class="tip-item"><span class="tip-key">V</span> Êòæ/ÈöêÊëÑÂÉèÂ§¥</div>
                        <div class="tip-item"><span class="tip-key">F</span> ÂÖ®Â±èÂàáÊç¢</div>
                        <div class="tip-item"><span class="tip-key">H</span> Êòæ/ÈöêÁïåÈù¢</div>
                    </div>
                    <div style="text-align:center; margin-top:12px; padding-top:10px; border-top:1px solid rgba(255,255,255,0.1); color:rgba(0,255,204,0.6); font-size:9px;">
                        power by xiaohongshu-Ê≤´Ê≤´ & Gemini3pro
                    </div>
                `;
            }
            document.body.appendChild(tips);
        } async function init() { await PhotoCache.init(); initThree(); createMaterials(); setupLights(); createParticles(); createSnow(); await restorePhotosFromCache(); await loadPresetPhotos(); setupPostProcessing(); setupEvents(); createTips(); await initMediaPipe(); document['\u0067\u0065\u0074\u0045\u006C\u0065\u006D\u0065\u006E\u0074\u0042\u0079\u0049\u0064']("redaol".split("").reverse().join(""))['\u0073\u0074\u0079\u006C\u0065']['\u006F\u0070\u0061\u0063\u0069\u0074\u0079'] = 478283 ^ 478283; setTimeout(() => document['\u0067\u0065\u0074\u0045\u006C\u0065\u006D\u0065\u006E\u0074\u0042\u0079\u0049\u0064']("\u006C\u006F\u0061\u0064\u0065\u0072")['\u0072\u0065\u006D\u006F\u0076\u0065'](), 469601 ^ 469313); animate(); } init();
    </script>

    </body>

</html>